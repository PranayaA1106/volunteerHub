<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolunteerHub - Login</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="auth-box">
            <h1>ü§ù VolunteerHub</h1>
            <p class="tagline">Connecting Hearts, Creating Impact</p>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('login')">Login</button>
                <button class="tab-btn" onclick="showTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form">
                <h2>Welcome Back!</h2>
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="Email" required>
                
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Password" required>
                
                <button type="submit" class="btn-primary">Login</button>
                <p class="error-msg" id="loginError"></p>
            </form>

            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" style="display:none;">
                <h2>Join Us Today!</h2>
                <input type="email" id="signupEmail" placeholder="Email" required>
                <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required>
                
                <label class="role-label">I am a:</label>
                <select id="role" required>
                    <option value="">Select Role</option>
                    <option value="volunteer">üôã Volunteer</option>
                    <option value="ngo">üè¢ NGO</option>
                </select>
                
                <button type="submit" class="btn-primary">Sign Up</button>
                <p class="error-msg" id="signupError"></p>
            </form>
        </div>
    </div>

    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
            authDomain: "volunteerhub-5c419.firebaseapp.com",
            projectId: "volunteerhub-5c419",
            storageBucket: "volunteerhub-5c419.firebasestorage.app",
            messagingSenderId: "769987727654",
            appId: "1:769987727654:web:20f964e64bcae74d8bb1e7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make globally available
        window.auth = auth;
        window.db = db;

        // Login Handler
 document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorMsg = document.getElementById('loginError');

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            console.log("Auth Success:", userCredential.user.uid);

            // Detailed Firestore Fetch
            const docRef = doc(db, 'users', userCredential.user.uid);
            // Inside your loginForm submit handler in index.html
const userDoc = await getDoc(doc(db, 'users', user.uid));

if (userDoc.exists()) {
    const data = userDoc.data();
    // If the role exists, send them to their dashboard
    if (data.role === 'volunteer') {
        window.location.href = 'profile.html'; // Or volunteer.html if already done
    } else if (data.role === 'ngo') {
        window.location.href = 'ngo.html';
    }
} else {
    // CRITICAL: If the document is missing, create a basic one so they aren't locked out!
    await setDoc(doc(db, 'users', user.uid), {
        uid: user.uid,
        email: user.email,
        role: 'volunteer' // Defaulting to volunteer for now
    });
    window.location.href = 'profile.html';
}
        } catch (error) {
            console.error("DEBUG ERROR:", error); // LOOK AT THIS IN THE CONSOLE
            errorMsg.textContent = error.message;
        }
    });

        // Signup Handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('role').value;
            const errorMsg = document.getElementById('signupError');

            if (!role) {
                errorMsg.textContent = 'Please select a role';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Save user in Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });

                // Redirect based on role
                if (role === 'volunteer') {
                    window.location.href = 'profile.html';
                } else if (role === 'ngo') {
                    window.location.href = 'ngo.html';
                }
            } catch (error) {
                errorMsg.textContent = error.message;
            }
        });

        // Tab switching
        window.showTab = (tab) => {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('.tab-btn');

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        };
    </script>
</body>
</html>
