<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Profile — VolunteerHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --teal-deep:   #2d6a75;
    --teal-mid:    #4e9aa6;
    --teal-soft:   #b8dde3;
    --teal-pale:   #e8f5f7;
    --orange-mid:  #f0a070;
    --orange-deep: #d4743a;
    --orange-pale: #fef6f0;
    --blush:       #f9d4bc;
    --cream:       #faf8f5;
    --ink:         #1c2b2e;
    --ink-mid:     #3d5457;
    --ink-light:   #7a9498;
    --border:      #ddeaec;
    --white:       #ffffff;
}

html, body {
    min-height: 100vh;
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
}

/* ─── LAYOUT ─────────────────────────────────────── */
.page {
    display: grid;
    grid-template-columns: 380px 1fr;
    min-height: 100vh;
}

/* ─── LEFT PANEL ──────────────────────────────────── */
.left-panel {
    background: linear-gradient(160deg, var(--teal-deep) 0%, var(--teal-mid) 55%, var(--orange-mid) 100%);
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 44px 44px;
    overflow: hidden;
}

.left-panel::before {
    content: '';
    position: absolute;
    width: 420px; height: 420px;
    border-radius: 50%;
    background: rgba(255,255,255,0.06);
    top: -120px; right: -120px;
}
.left-panel::after {
    content: '';
    position: absolute;
    width: 240px; height: 240px;
    border-radius: 50%;
    background: rgba(255,255,255,0.05);
    bottom: -60px; left: -40px;
}

.panel-top { position: relative; z-index: 1; }
.panel-top img { width: 150px; height: auto; }
.panel-top .wordmark {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px; font-weight: 600;
    color: white; margin-top: 4px;
}

.panel-mid { position: relative; z-index: 1; }
.panel-mid .headline {
    font-family: 'Cormorant Garamond', serif;
    font-size: 44px; font-weight: 700;
    color: white; line-height: 1.1;
    margin-bottom: 16px;
}
.panel-mid .headline em { font-style: italic; color: var(--blush); }
.panel-mid p {
    font-size: 15px;
    color: rgba(255,255,255,0.72);
    line-height: 1.7; max-width: 300px;
}

/* step progress on the left */
.steps {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-top: 36px;
}

.step {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 15px;
    top: 32px;
    width: 2px;
    height: 36px;
    background: rgba(255,255,255,0.2);
}

.step-dot {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    color: rgba(255,255,255,0.5);
    font-size: 13px; font-weight: 700;
    transition: all 0.3s;
    margin-top: 2px;
}
.step-dot svg { width: 14px; height: 14px; }

.step.active .step-dot {
    background: white;
    border-color: white;
    color: var(--teal-deep);
}
.step.done .step-dot {
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.step-text { padding-bottom: 36px; }
.step-title {
    font-size: 14px; font-weight: 600;
    color: white; margin-bottom: 2px;
}
.step-desc { font-size: 12px; color: rgba(255,255,255,0.5); }
.step:not(.active):not(.done) .step-title { color: rgba(255,255,255,0.45); }

.panel-bottom {
    position: relative; z-index: 1;
    font-size: 12px; color: rgba(255,255,255,0.35);
}

/* ─── RIGHT PANEL ─────────────────────────────────── */
.right-panel {
    background: var(--white);
    padding: 52px 64px;
    overflow-y: auto;
}

/* ─── TOP BAR ─────────────────────────────────────── */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 40px;
}

.progress-track {
    flex: 1;
    max-width: 320px;
    height: 6px;
    background: var(--border);
    border-radius: 99px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--teal-mid), var(--orange-mid));
    transition: width 0.5s cubic-bezier(0.22,1,0.36,1);
    width: 0%;
}
.progress-label {
    font-size: 13px; color: var(--ink-light);
    font-weight: 500; white-space: nowrap;
    margin-left: 14px;
}

/* ─── FORM HEADING ────────────────────────────────── */
.form-eyebrow {
    font-size: 11px; font-weight: 600;
    letter-spacing: 2.5px; text-transform: uppercase;
    color: var(--orange-mid); margin-bottom: 8px;
}
.form-heading {
    font-family: 'Cormorant Garamond', serif;
    font-size: 38px; font-weight: 600;
    color: var(--ink); margin-bottom: 6px; line-height: 1.1;
}
.form-subheading {
    font-size: 15px; color: var(--ink-light);
    margin-bottom: 36px; line-height: 1.6;
}

/* ─── FIELDS ──────────────────────────────────────── */
.fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
}
.field-full { grid-column: 1 / -1; }

.field { display: flex; flex-direction: column; gap: 7px; }

.field label {
    font-size: 13px; font-weight: 600;
    color: var(--ink-mid); letter-spacing: 0.2px;
}

.input-wrap {
    position: relative; display: flex; align-items: center;
}
.input-wrap .field-icon {
    position: absolute; left: 14px;
    width: 17px; height: 17px;
    color: var(--ink-light); pointer-events: none; flex-shrink: 0;
}
.input-wrap input,
.input-wrap select {
    width: 100%;
    padding: 13px 14px 13px 44px;
    border: 1.5px solid var(--border);
    border-radius: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px; color: var(--ink);
    background: var(--white);
    transition: border 0.22s, box-shadow 0.22s;
    appearance: none;
}
.input-wrap input:focus,
.input-wrap select:focus {
    outline: none;
    border-color: var(--teal-mid);
    box-shadow: 0 0 0 3px rgba(78,154,166,0.12);
}
.input-wrap input::placeholder { color: var(--ink-light); }
.select-arrow {
    position: absolute; right: 14px;
    pointer-events: none; color: var(--ink-light);
}
.select-arrow svg { width: 15px; height: 15px; }

/* ─── SECTION LABELS ──────────────────────────────── */
.section-label {
    font-size: 11px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--ink-light); margin-bottom: 12px;
    display: flex; align-items: center; gap: 8px;
}
.section-label::after {
    content: '';
    flex: 1; height: 1px; background: var(--border);
}

/* ─── CHIP GRID ───────────────────────────────────── */
.chip-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 28px;
}

.chip {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 16px;
    border: 1.5px solid var(--border);
    border-radius: 99px;
    background: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 500;
    color: var(--ink-mid);
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}
.chip input { display: none; }
.chip svg { width: 15px; height: 15px; color: var(--ink-light); transition: color 0.2s; flex-shrink: 0; }

.chip:hover {
    border-color: var(--teal-mid);
    background: var(--teal-pale);
    color: var(--teal-deep);
}
.chip:hover svg { color: var(--teal-mid); }

.chip.selected {
    border-color: var(--teal-mid);
    background: var(--teal-pale);
    color: var(--teal-deep);
    font-weight: 600;
}
.chip.selected svg { color: var(--teal-mid); }

/* interest chips get orange when selected */
.chip.interest.selected {
    border-color: var(--orange-mid);
    background: var(--orange-pale);
    color: var(--orange-deep);
}
.chip.interest.selected svg { color: var(--orange-mid); }
.chip.interest:hover {
    border-color: var(--orange-mid);
    background: var(--orange-pale);
    color: var(--orange-deep);
}
.chip.interest:hover svg { color: var(--orange-mid); }

/* ─── AVAILABILITY GRID ───────────────────────────── */
.avail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 32px;
}

.avail-option {
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 16px 18px;
    cursor: pointer;
    display: flex; align-items: center; gap: 12px;
    font-size: 14px; font-weight: 500; color: var(--ink-mid);
    transition: all 0.22s; background: white; user-select: none;
}
.avail-option input { display: none; }
.avail-icon {
    width: 36px; height: 36px;
    border-radius: 11px; background: var(--teal-pale);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; color: var(--teal-mid); transition: all 0.22s;
}
.avail-icon svg { width: 17px; height: 17px; }
.avail-text { display: flex; flex-direction: column; }
.avail-title { font-size: 14px; font-weight: 600; color: var(--ink); }
.avail-sub   { font-size: 12px; color: var(--ink-light); margin-top: 2px; }

.avail-option:hover { border-color: var(--teal-mid); background: var(--teal-pale); }
.avail-option.selected { border-color: var(--teal-mid); background: var(--teal-pale); }
.avail-option.selected .avail-icon {
    background: linear-gradient(135deg, var(--teal-mid), var(--orange-mid));
    color: white;
}

/* ─── SUBMIT ──────────────────────────────────────── */
.form-footer {
    display: flex; align-items: center; gap: 16px;
    margin-top: 8px;
}

.btn-submit {
    flex: 1; padding: 16px;
    background: linear-gradient(135deg, var(--teal-mid), var(--orange-mid));
    color: white; border: none; border-radius: 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: all 0.25s;
}
.btn-submit svg { width: 18px; height: 18px; }
.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 32px rgba(78,154,166,0.28);
}
.btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

.selection-summary {
    font-size: 13px; color: var(--ink-light);
    text-align: right; min-width: 100px;
}
.selection-summary span { color: var(--teal-mid); font-weight: 600; }

/* ─── MESSAGES ────────────────────────────────────── */
.msg {
    margin-top: 14px; padding: 13px 16px;
    border-radius: 12px; font-size: 13px; font-weight: 500;
    display: none; align-items: center; gap: 9px; line-height: 1.5;
}
.msg.error   { background: #fff5f5; color: #c53030; border: 1px solid #fecaca; display: flex; }
.msg.success { background: #f0faf5; color: #2d8a5e; border: 1px solid #a7f0c8; display: flex; }
.msg svg { width: 16px; height: 16px; flex-shrink: 0; }

.spinner-sm {
    width: 17px; height: 17px;
    border: 2px solid rgba(255,255,255,0.35);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.6s linear infinite; flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ─── RESPONSIVE ──────────────────────────────────── */
@media (max-width: 1000px) {
    .page { grid-template-columns: 1fr; }
    .left-panel { position: relative; height: auto; min-height: 260px; padding: 36px 32px; }
    .left-panel::before, .left-panel::after { display: none; }
    .panel-mid .headline { font-size: 34px; }
    .steps { display: none; }
    .right-panel { padding: 36px 32px; }
    .fields-grid { grid-template-columns: 1fr; }
    .avail-grid { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
    .right-panel { padding: 28px 20px; }
    .form-heading { font-size: 30px; }
    .avail-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="page">

    <!-- ── LEFT PANEL ── -->
    <div class="left-panel">
        <div class="panel-top">
            <img src="images/volunteerhub-logo.png" alt="VolunteerHub"
                 onerror="this.style.display='none'">
            <div class="wordmark">VolunteerHub</div>
        </div>

        <div class="panel-mid">
            <h1 class="headline">Let's set<br>up your<br><em>profile.</em></h1>
            <p>Tell us a little about yourself so we can match you with the best volunteer opportunities.</p>

            <div class="steps" id="stepsPanel">
                <div class="step active" id="step1">
                    <div class="step-dot"><i data-lucide="user"></i></div>
                    <div class="step-text">
                        <div class="step-title">Basic Info</div>
                        <div class="step-desc">Name & location</div>
                    </div>
                </div>
                <div class="step" id="step2">
                    <div class="step-dot"><i data-lucide="zap"></i></div>
                    <div class="step-text">
                        <div class="step-title">Skills</div>
                        <div class="step-desc">What you're good at</div>
                    </div>
                </div>
                <div class="step" id="step3">
                    <div class="step-dot"><i data-lucide="clock"></i></div>
                    <div class="step-text">
                        <div class="step-title">Availability</div>
                        <div class="step-desc">When you can help</div>
                    </div>
                </div>
                <div class="step" id="step4">
                    <div class="step-dot"><i data-lucide="heart"></i></div>
                    <div class="step-text">
                        <div class="step-title">Interests</div>
                        <div class="step-desc">Causes you care about</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-bottom">© 2025 VolunteerHub</div>
    </div>

    <!-- ── RIGHT PANEL ── -->
    <div class="right-panel">

        <!-- PROGRESS BAR -->
        <div class="top-bar">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-label" id="progressLabel">Step 1 of 4</span>
        </div>

        <p class="form-eyebrow">Profile Setup</p>
        <h1 class="form-heading">Tell us about yourself</h1>
        <p class="form-subheading">This helps us personalise your volunteer matches.</p>

        <form id="profileForm" novalidate>

            <!-- BASIC INFO -->
            <div class="fields-grid">
                <div class="field">
                    <label>Full name</label>
                    <div class="input-wrap">
                        <i data-lucide="user" class="field-icon"></i>
                        <input type="text" id="name" placeholder="Your name" required>
                    </div>
                </div>
                <div class="field">
                    <label>Location</label>
                    <div class="input-wrap">
                        <i data-lucide="map-pin" class="field-icon"></i>
                        <input type="text" id="location" placeholder="City, Country" required>
                    </div>
                </div>
                <div class="field field-full">
                    <label>Bio <span style="font-weight:400;color:var(--ink-light)">(optional)</span></label>
                    <div class="input-wrap">
                        <i data-lucide="file-text" class="field-icon"></i>
                        <input type="text" id="bio" placeholder="A short line about yourself…">
                    </div>
                </div>
            </div>

            <!-- SKILLS -->
            <p class="section-label">Skills</p>
            <div class="chip-grid" id="skillsGrid">
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="teaching">
                    <i data-lucide="book-open"></i> Teaching
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="medical">
                    <i data-lucide="heart-pulse"></i> Medical
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="tech">
                    <i data-lucide="code-2"></i> Technology
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="design">
                    <i data-lucide="pen-tool"></i> Design
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="writing">
                    <i data-lucide="pencil"></i> Writing
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="legal">
                    <i data-lucide="scale"></i> Legal
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="marketing">
                    <i data-lucide="megaphone"></i> Marketing
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="fundraising">
                    <i data-lucide="hand-coins"></i> Fundraising
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="cooking">
                    <i data-lucide="utensils"></i> Cooking
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="logistics">
                    <i data-lucide="truck"></i> Logistics
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="empathy">
                    <i data-lucide="heart"></i> Empathy
                </label>
                <label class="chip skill">
                    <input type="checkbox" name="skills" value="patience">
                    <i data-lucide="hourglass"></i> Patience
                </label>
            </div>

            <!-- AVAILABILITY -->
            <p class="section-label">Availability</p>
            <div class="avail-grid">
                <label class="avail-option" data-value="weekends">
                    <input type="radio" name="availability" value="weekends">
                    <span class="avail-icon"><i data-lucide="sun"></i></span>
                    <span class="avail-text">
                        <span class="avail-title">Weekends</span>
                        <span class="avail-sub">Saturdays & Sundays</span>
                    </span>
                </label>
                <label class="avail-option" data-value="weekdays">
                    <input type="radio" name="availability" value="weekdays">
                    <span class="avail-icon"><i data-lucide="briefcase"></i></span>
                    <span class="avail-text">
                        <span class="avail-title">Weekdays</span>
                        <span class="avail-sub">Monday to Friday</span>
                    </span>
                </label>
                <label class="avail-option" data-value="flexible">
                    <input type="radio" name="availability" value="flexible">
                    <span class="avail-icon"><i data-lucide="calendar"></i></span>
                    <span class="avail-text">
                        <span class="avail-title">Flexible</span>
                        <span class="avail-sub">Any time works</span>
                    </span>
                </label>
                <label class="avail-option" data-value="one-time">
                    <input type="radio" name="availability" value="one-time">
                    <span class="avail-icon"><i data-lucide="star"></i></span>
                    <span class="avail-text">
                        <span class="avail-title">One-time Events</span>
                        <span class="avail-sub">Special occasions only</span>
                    </span>
                </label>
            </div>

            <!-- INTERESTS -->
            <p class="section-label">Causes I care about</p>
            <div class="chip-grid" id="interestsGrid">
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="education">
                    <i data-lucide="graduation-cap"></i> Education
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="health">
                    <i data-lucide="heart-pulse"></i> Health
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="environment">
                    <i data-lucide="leaf"></i> Environment
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="animals">
                    <i data-lucide="paw-print"></i> Animals
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="poverty">
                    <i data-lucide="hand-helping"></i> Poverty Relief
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="children">
                    <i data-lucide="baby"></i> Children
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="elderly">
                    <i data-lucide="users"></i> Elderly Care
                </label>
                <label class="chip interest">
                    <input type="checkbox" name="interests" value="disaster">
                    <i data-lucide="shield"></i> Disaster Relief
                </label>
            </div>

            <!-- FOOTER -->
            <div class="form-footer">
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i data-lucide="arrow-right"></i> Save & Find Opportunities
                </button>
                <div class="selection-summary" id="selectionSummary">
                    <span id="skillCount">0</span> skills · <span id="interestCount">0</span> causes
                </div>
            </div>

            <div class="msg" id="formMsg"></div>
        </form>

    </div>
</div>

<script>
lucide.createIcons();

// ─── Progress tracking ─────────────────────────────
const sections = ['name', 'skills', 'availability', 'interests'];
let progress = { name: false, skills: false, availability: false, interests: false };

function updateProgress() {
    const done = Object.values(progress).filter(Boolean).length;
    const pct  = (done / 4) * 100;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').textContent = `${done} of 4 complete`;

    // Update left panel steps
    const stepMap = ['step1','step2','step3','step4'];
    stepMap.forEach((id, i) => {
        const el = document.getElementById(id);
        const key = sections[i];
        el.classList.remove('active','done');
        if (progress[key]) el.classList.add('done');
        else if (!Object.values(progress).slice(0, i).includes(false) &&
                 !progress[key]) el.classList.add('active');
    });

    // Update selection summary
    const skillCount    = document.querySelectorAll('input[name="skills"]:checked').length;
    const interestCount = document.querySelectorAll('input[name="interests"]:checked').length;
    document.getElementById('skillCount').textContent    = skillCount;
    document.getElementById('interestCount').textContent = interestCount;
}

// Track name input
document.getElementById('name').addEventListener('input', function() {
    progress.name = this.value.trim().length > 0;
    updateProgress();
});

// Chip toggles — skills
document.querySelectorAll('.chip.skill').forEach(chip => {
    chip.addEventListener('click', () => {
        const cb = chip.querySelector('input');
        cb.checked = !cb.checked;
        chip.classList.toggle('selected', cb.checked);
        progress.skills = document.querySelectorAll('input[name="skills"]:checked').length > 0;
        updateProgress();
    });
});

// Chip toggles — interests
document.querySelectorAll('.chip.interest').forEach(chip => {
    chip.addEventListener('click', () => {
        const cb = chip.querySelector('input');
        cb.checked = !cb.checked;
        chip.classList.toggle('selected', cb.checked);
        progress.interests = document.querySelectorAll('input[name="interests"]:checked').length > 0;
        updateProgress();
    });
});

// Availability cards
document.querySelectorAll('.avail-option').forEach(opt => {
    opt.addEventListener('click', () => {
        document.querySelectorAll('.avail-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        opt.querySelector('input').checked = true;
        progress.availability = true;
        updateProgress();
    });
});

function showMsg(text, type) {
    const el = document.getElementById('formMsg');
    el.className = `msg ${type}`;
    el.innerHTML = `<i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}"></i> ${text}`;
    lucide.createIcons();
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function setLoading(loading) {
    const btn = document.getElementById('submitBtn');
    if (loading) {
        btn.disabled = true;
        btn.innerHTML = `<div class="spinner-sm"></div> Saving…`;
    } else {
        btn.disabled = false;
        btn.innerHTML = `<i data-lucide="arrow-right"></i> Save & Find Opportunities`;
        lucide.createIcons();
    }
}

// Init
updateProgress();
</script>

<script type="module">
import { initializeApp }        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey:            "AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
    authDomain:        "volunteerhub-5c419.firebaseapp.com",
    projectId:         "volunteerhub-5c419",
    storageBucket:     "volunteerhub-5c419.firebasestorage.app",
    messagingSenderId: "769987727654",
    appId:             "1:769987727654:web:20f964e64bcae74d8bb1e7"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
let currentUser = null;

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;

        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
            const data = userDoc.data();

            // Pre-fill name if already saved
            if (data.name) {
                document.getElementById('name').value = data.name;
                window.progress.name = true;
            }
            if (data.location) {
                document.getElementById('location').value = data.location;
            }
            if (data.bio) {
                document.getElementById('bio').value = data.bio;
            }

            // Pre-check skills
            if (data.skills) {
                data.skills.forEach(val => {
                    const cb = document.querySelector(`input[name="skills"][value="${val}"]`);
                    if (cb) { cb.checked = true; cb.closest('.chip').classList.add('selected'); }
                });
                window.progress.skills = data.skills.length > 0;
            }

            // Pre-select availability
            if (data.availability) {
                const opt = document.querySelector(`.avail-option[data-value="${data.availability}"]`);
                if (opt) {
                    opt.classList.add('selected');
                    opt.querySelector('input').checked = true;
                    window.progress.availability = true;
                }
            }

            // Pre-check interests
            if (data.interests) {
                data.interests.forEach(val => {
                    const cb = document.querySelector(`input[name="interests"][value="${val}"]`);
                    if (cb) { cb.checked = true; cb.closest('.chip').classList.add('selected'); }
                });
                window.progress.interests = data.interests.length > 0;
            }

            window.updateProgress();

            // Only redirect if user came here from login (not fresh signup).
            // Signup always needs to fill profile first.
            // index.html sets sessionStorage 'fromLogin' = 'true' before redirecting here.
            const cameFromLogin = sessionStorage.getItem('fromLogin') === 'true';
            sessionStorage.removeItem('fromLogin');

            if (cameFromLogin && data.profileCompleted && data.skills?.length && data.interests?.length && data.availability) {
                window.location.href = 'volunteer.html';
            }
        }
    } else {
        window.location.href = 'index.html';
    }
});

document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) { showMsg('Please log in first.', 'error'); return; }

    const name         = document.getElementById('name').value.trim();
    const location     = document.getElementById('location').value.trim();
    const bio          = document.getElementById('bio').value.trim();
    const availability = document.querySelector('input[name="availability"]:checked')?.value;
    const skills       = [...document.querySelectorAll('input[name="skills"]:checked')].map(c => c.value);
    const interests    = [...document.querySelectorAll('input[name="interests"]:checked')].map(c => c.value);

    // Validate
    if (!name)         { showMsg('Please enter your full name.', 'error'); return; }
    if (!location)     { showMsg('Please enter your location.', 'error'); return; }
    if (!skills.length)    { showMsg('Please select at least one skill.', 'error'); return; }
    if (!availability)     { showMsg('Please select your availability.', 'error'); return; }
    if (!interests.length) { showMsg('Please select at least one cause you care about.', 'error'); return; }

    setLoading(true);

    try {
        await setDoc(doc(db, 'users', currentUser.uid), {
            name, location, bio, skills, availability, interests,
            profileCompleted: true,
            updatedAt: new Date().toISOString()
        }, { merge: true });

        showMsg('Profile saved! Redirecting to your opportunities…', 'success');
        setTimeout(() => { window.location.href = 'volunteer.html'; }, 1200);

    } catch (err) {
        setLoading(false);
        showMsg(err.message, 'error');
    }
});

// Expose to global scope for pre-fill script
window.updateProgress = window.updateProgress || (() => {});
</script>
</body>
</html>
