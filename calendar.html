<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Calendar — VolunteerHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --teal-deep:   #2d6a75;
    --teal-mid:    #4e9aa6;
    --teal-soft:   #b8dde3;
    --teal-pale:   #e8f5f7;
    --orange-mid:  #f0a070;
    --orange-deep: #d4743a;
    --orange-pale: #fef6f0;
    --blush:       #f9d4bc;
    --cream:       #faf8f5;
    --ink:         #1c2b2e;
    --ink-mid:     #3d5457;
    --ink-light:   #7a9498;
    --white:       #ffffff;
    --border:      #ddeaec;
    --sidebar-w:   260px;
}

html { scroll-behavior: smooth; }

body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    display: flex;
}

/* ─── SIDEBAR ──────────────────────────────────── */
.sidebar {
    width: var(--sidebar-w);
    min-height: 100vh;
    background: linear-gradient(160deg, var(--teal-deep) 0%, var(--teal-mid) 100%);
    border-radius: 0 36px 36px 0;
    padding: 36px 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: sticky;
    top: 0;
    height: 100vh;
    box-shadow: 6px 0 40px rgba(45,106,117,0.18);
    z-index: 10;
    flex-shrink: 0;
}
.logo img { width: 160px; height: auto; margin-bottom: 48px; display: block; }
.nav-links { display: flex; flex-direction: column; gap: 6px; }
.nav-links a {
    color: rgba(255,255,255,0.75);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 13px 16px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.2px;
    transition: all 0.25s ease;
}
.nav-links a svg { width: 17px; height: 17px; flex-shrink: 0; }
.nav-links a:hover { background: rgba(255,255,255,0.12); color: white; transform: translateX(4px); }
.nav-links a.active { background: white; color: var(--teal-deep); font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
.sidebar-footer { border-top: 1px solid rgba(255,255,255,0.15); padding-top: 20px; }
.logout-btn {
    width: 100%; padding: 13px;
    background: rgba(255,255,255,0.12);
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    font-size: 14px; font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.25s;
}
.logout-btn svg { width: 16px; height: 16px; }
.logout-btn:hover { background: rgba(255,255,255,0.22); transform: translateY(-1px); }

/* ─── MAIN ─────────────────────────────────────── */
.main-content {
    flex: 1;
    padding: 40px 48px;
    overflow-y: auto;
    min-height: 100vh;
}

/* ─── PAGE HEADER ──────────────────────────────── */
.page-header { margin-bottom: 36px; }
.page-header .eyebrow {
    font-size: 12px; font-weight: 600;
    letter-spacing: 2.5px; text-transform: uppercase;
    color: var(--orange-mid); margin-bottom: 10px;
}
.page-header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 54px; font-weight: 600;
    color: var(--ink); line-height: 1.1;
}
.page-header h1 em { font-style: italic; color: var(--teal-mid); }
.page-header .subtitle { font-size: 15px; color: var(--ink-light); margin-top: 8px; }

/* ─── LAYOUT ───────────────────────────────────── */
.calendar-layout {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 28px;
    align-items: start;
}

/* ─── CALENDAR CARD ────────────────────────────── */
.calendar-card {
    background: white;
    border-radius: 28px;
    padding: 36px;
    box-shadow: 0 4px 32px rgba(45,106,117,0.07);
    border: 1px solid var(--border);
}

/* ─── CALENDAR NAV ─────────────────────────────── */
.cal-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
}
.cal-nav-btn {
    width: 40px; height: 40px;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--ink-mid);
    transition: all 0.2s;
}
.cal-nav-btn svg { width: 18px; height: 18px; }
.cal-nav-btn:hover { border-color: var(--teal-mid); color: var(--teal-mid); background: var(--teal-pale); }

.cal-month {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 600;
    color: var(--ink);
    text-align: center;
}
.cal-year {
    font-size: 14px;
    color: var(--ink-light);
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    display: block;
    text-align: center;
    margin-top: 2px;
}

/* ─── DAY LABELS ───────────────────────────────── */
.cal-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    margin-bottom: 8px;
}
.cal-weekday {
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--ink-light);
    padding: 8px 0;
}

/* ─── GRID ─────────────────────────────────────── */
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.cal-day {
    aspect-ratio: 1;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: default;
    position: relative;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    color: var(--ink-mid);
}

.cal-day.empty { background: transparent; cursor: default; }

.cal-day.other-month { color: var(--border); }

.cal-day:not(.empty):not(.other-month):hover {
    background: var(--teal-pale);
    color: var(--teal-deep);
}

.cal-day.today {
    background: var(--teal-pale);
    color: var(--teal-deep);
    font-weight: 700;
    border: 2px solid var(--teal-soft);
}

/* Day with application(s) */
.cal-day.has-event {
    background: linear-gradient(135deg, var(--teal-pale), var(--orange-pale));
    color: var(--ink);
    font-weight: 700;
    cursor: pointer;
    border: 2px solid var(--blush);
}
.cal-day.has-event:hover {
    background: linear-gradient(135deg, var(--teal-soft), var(--blush));
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(240,160,112,0.25);
    z-index: 2;
}

/* dot indicator */
.event-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--orange-mid);
    position: absolute;
    bottom: 5px;
}

/* Multiple events dot row */
.event-dots {
    display: flex;
    gap: 3px;
    position: absolute;
    bottom: 5px;
}
.event-dots span {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--orange-mid);
    display: block;
}
.event-dots span:nth-child(2) { background: var(--teal-mid); }
.event-dots span:nth-child(3) { background: var(--blush); }

.cal-day.today .event-dots span { background: white; }

/* ─── LEGEND ───────────────────────────────────── */
.cal-legend {
    display: flex;
    gap: 20px;
    margin-top: 24px;
    flex-wrap: wrap;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--ink-light);
}
.legend-swatch {
    width: 26px; height: 26px;
    border-radius: 8px;
}
.legend-swatch.today-sw  { background: var(--teal-pale); border: 2px solid var(--teal-soft); }
.legend-swatch.event-sw  { background: linear-gradient(135deg, var(--teal-pale), var(--orange-pale)); border: 2px solid var(--blush); }

/* ─── SIDEBAR PANEL ────────────────────────────── */
.side-panel { display: flex; flex-direction: column; gap: 20px; }

/* Stats row */
.stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
}
.stat-box {
    background: white;
    border-radius: 20px;
    padding: 22px 18px;
    border: 1px solid var(--border);
    box-shadow: 0 2px 16px rgba(45,106,117,0.05);
    text-align: center;
    transition: all 0.22s;
}
.stat-box:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(45,106,117,0.1); }
.stat-box-icon {
    width: 38px; height: 38px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 10px;
}
.stat-box-icon svg { width: 18px; height: 18px; }
.stat-box-icon.orange { background: var(--orange-pale); color: var(--orange-deep); }
.stat-box-icon.teal   { background: var(--teal-pale);   color: var(--teal-deep); }
.stat-box-icon.green  { background: #f0faf5;             color: #2d8a5e; }
.stat-box-icon.blush  { background: var(--orange-pale);  color: var(--orange-deep); }
.stat-box-value { font-size: 32px; font-weight: 700; color: var(--ink); line-height: 1; }
.stat-box-label { font-size: 12px; color: var(--ink-light); margin-top: 4px; }

/* Selected day panel */
.day-panel {
    background: white;
    border-radius: 24px;
    padding: 28px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 24px rgba(45,106,117,0.06);
    animation: fadeUp 0.3s ease;
}
.day-panel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}
.day-panel-header h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--ink);
}
.day-panel-header svg { width: 20px; height: 20px; color: var(--orange-mid); }

.day-empty {
    text-align: center;
    padding: 24px 0;
    color: var(--ink-light);
    font-size: 14px;
}
.day-empty svg { width: 36px; height: 36px; margin: 0 auto 10px; display: block; color: var(--border); }

/* Activity item in day panel */
.activity-item {
    padding: 16px;
    border-radius: 16px;
    border: 1.5px solid var(--border);
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: default;
}
.activity-item:last-child { margin-bottom: 0; }
.activity-item:hover { border-color: var(--teal-soft); background: var(--teal-pale); transform: translateX(3px); }

.activity-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
}
.activity-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--ink);
    line-height: 1.3;
}
.status-pill {
    padding: 3px 10px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
}
.status-pill.pending  { background: #fff4e5; color: #b7580e; border: 1px solid #fcd5a0; }
.status-pill.approved { background: #f0faf5; color: #2d8a5e; border: 1px solid #a7f0c8; }
.status-pill.rejected { background: #fff5f5; color: #c53030; border: 1px solid #fecaca; }

.activity-ngo {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--ink-light);
    font-weight: 500;
}
.activity-ngo svg { width: 12px; height: 12px; color: var(--teal-mid); }

/* All applications list */
.all-apps-card {
    background: white;
    border-radius: 24px;
    padding: 28px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 24px rgba(45,106,117,0.06);
}
.all-apps-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}
.all-apps-header h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--ink);
}
.all-apps-header svg { width: 20px; height: 20px; color: var(--teal-mid); }

.app-timeline { display: flex; flex-direction: column; gap: 0; }

.timeline-item {
    display: flex;
    gap: 16px;
    padding-bottom: 20px;
    position: relative;
}
.timeline-item:last-child { padding-bottom: 0; }
.timeline-item:last-child .tl-line { display: none; }

.tl-dot-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    width: 20px;
}
.tl-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--teal-mid), var(--orange-mid));
    flex-shrink: 0;
    margin-top: 4px;
    box-shadow: 0 0 0 3px var(--teal-pale);
}
.tl-line {
    flex: 1;
    width: 2px;
    background: var(--border);
    margin-top: 6px;
}

.tl-content { flex: 1; }
.tl-date {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--ink-light);
    margin-bottom: 6px;
}
.tl-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 4px;
    line-height: 1.3;
}
.tl-ngo {
    font-size: 12px;
    color: var(--ink-light);
    display: flex;
    align-items: center;
    gap: 5px;
}
.tl-ngo svg { width: 11px; height: 11px; color: var(--teal-mid); }

/* ─── ANIMATIONS ───────────────────────────────── */
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}

.calendar-card  { animation: fadeUp 0.4s ease 0.05s both; }
.side-panel > * { animation: fadeUp 0.4s ease both; }
.side-panel > *:nth-child(1) { animation-delay: 0.1s; }
.side-panel > *:nth-child(2) { animation-delay: 0.2s; }
.side-panel > *:nth-child(3) { animation-delay: 0.3s; }

/* ─── RESPONSIVE ───────────────────────────────── */
@media (max-width: 1100px) {
    .calendar-layout { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(4, 1fr); }
}
@media (max-width: 900px) {
    .main-content { padding: 28px 24px; }
    .page-header h1 { font-size: 38px; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 680px) {
    body { flex-direction: column; }
    .sidebar {
        width: 100%; min-height: unset; height: auto;
        border-radius: 0 0 28px 28px;
        padding: 20px 24px; position: relative;
        flex-direction: row; align-items: center;
        justify-content: space-between; flex-wrap: wrap; gap: 12px;
    }
    .logo img { width: 120px; margin-bottom: 0; }
    .nav-links { flex-direction: row; flex-wrap: wrap; gap: 6px; }
    .nav-links a { padding: 9px 14px; font-size: 13px; }
    .nav-links a:hover { transform: none; }
    .sidebar-footer { border-top: none; padding-top: 0; }
    .main-content { padding: 24px 16px; }
    .cal-day { font-size: 12px; border-radius: 8px; }
    .calendar-card { padding: 20px; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
    <div>
        <div class="logo">
            <img src="images/volunteerhub-logo.png" alt="VolunteerHub">
        </div>
        <nav class="nav-links">
            <a href="dashboard.html"><i data-lucide="bar-chart-3"></i> Dashboard</a>
            <a href="volunteer.html"><i data-lucide="briefcase"></i> Opportunities</a>
            <a href="quiz.html"><i data-lucide="sparkles"></i> Quiz</a>
            <a href="map.html"><i data-lucide="map"></i> Map</a>
            <a href="calendar.html" class="active"><i data-lucide="calendar"></i> Calendar</a>
        </nav>
    </div>
    <div class="sidebar-footer">
        <button onclick="logout()" class="logout-btn">
            <i data-lucide="log-out"></i> Logout
        </button>
    </div>
</aside>

<!-- MAIN -->
<main class="main-content">

    <div class="page-header">
        <p class="eyebrow">My Volunteer Journey</p>
        <h1>My <em>Calendar</em></h1>
        <p class="subtitle" id="subtitleText">Track every opportunity you've applied for</p>
    </div>

    <div class="calendar-layout">

        <!-- LEFT: CALENDAR -->
        <div class="calendar-card">
            <div class="cal-nav">
                <button class="cal-nav-btn" id="prevMonth"><i data-lucide="chevron-left"></i></button>
                <div>
                    <div class="cal-month" id="calMonthLabel">—</div>
                    <span class="cal-year" id="calYearLabel">—</span>
                </div>
                <button class="cal-nav-btn" id="nextMonth"><i data-lucide="chevron-right"></i></button>
            </div>

            <div class="cal-weekdays">
                <div class="cal-weekday">Su</div>
                <div class="cal-weekday">Mo</div>
                <div class="cal-weekday">Tu</div>
                <div class="cal-weekday">We</div>
                <div class="cal-weekday">Th</div>
                <div class="cal-weekday">Fr</div>
                <div class="cal-weekday">Sa</div>
            </div>

            <div class="cal-grid" id="calGrid"></div>

            <div class="cal-legend">
                <div class="legend-item">
                    <div class="legend-swatch today-sw"></div>
                    Today
                </div>
                <div class="legend-item">
                    <div class="legend-swatch event-sw"></div>
                    Applied on this day
                </div>
            </div>
        </div>

        <!-- RIGHT: SIDE PANEL -->
        <div class="side-panel">

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-box-icon orange"><i data-lucide="send"></i></div>
                    <div class="stat-box-value" id="statTotal">0</div>
                    <div class="stat-box-label">Total applied</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-icon teal"><i data-lucide="calendar-check"></i></div>
                    <div class="stat-box-value" id="statMonthCount">0</div>
                    <div class="stat-box-label">This month</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-icon green"><i data-lucide="check-circle"></i></div>
                    <div class="stat-box-value" id="statApproved">0</div>
                    <div class="stat-box-label">Approved</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-icon blush"><i data-lucide="clock"></i></div>
                    <div class="stat-box-value" id="statPending">0</div>
                    <div class="stat-box-label">Pending</div>
                </div>
            </div>

            <!-- Selected day detail -->
            <div class="day-panel" id="dayPanel">
                <div class="day-panel-header">
                    <i data-lucide="calendar-days"></i>
                    <h2 id="dayPanelTitle">Select a date</h2>
                </div>
                <div class="day-empty" id="dayEmpty">
                    <i data-lucide="mouse-pointer-click"></i>
                    <p>Click a highlighted date to see your applications for that day</p>
                </div>
                <div id="dayActivities"></div>
            </div>

            <!-- Full timeline -->
            <div class="all-apps-card">
                <div class="all-apps-header">
                    <i data-lucide="list-checks"></i>
                    <h2>All Applications</h2>
                </div>
                <div class="app-timeline" id="appTimeline">
                    <p style="color:var(--ink-light);font-size:14px">Loading…</p>
                </div>
            </div>

        </div>
    </div>

</main>

<script>lucide.createIcons();</script>

<script type="module">
import { initializeApp }       from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, query, where, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
    authDomain: "volunteerhub-5c419.firebaseapp.com",
    projectId: "volunteerhub-5c419",
    storageBucket: "volunteerhub-5c419.firebasestorage.app",
    messagingSenderId: "769987727654",
    appId: "1:769987727654:web:20f964e64bcae74d8bb1e7"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

let currentUser = null;
// Map: "YYYY-MM-DD" → [ { title, ngoName, status, appliedAt } ]
let eventMap = {};
let allApps  = [];

// Calendar state
const MONTHS = ['January','February','March','April','May','June',
                'July','August','September','October','November','December'];
let viewYear, viewMonth;

// ─── Auth ─────────────────────────────────────────
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().role === 'volunteer') {
            const name = userDoc.data().name || '';
            if (name) document.getElementById('subtitleText').textContent =
                `Welcome back, ${name.split(' ')[0]} — here's your volunteer journey`;
            await loadApplications();
        } else {
            window.location.href = 'index.html';
        }
    } else {
        window.location.href = 'index.html';
    }
});

window.logout = async () => { await signOut(auth); window.location.href = 'index.html'; };

// ─── Load data ────────────────────────────────────
async function loadApplications() {
    try {
        const q    = query(collection(db, 'applications'), where('volunteerId', '==', currentUser.uid));
        const snap = await getDocs(q);

        const enriched = [];

        for (const d of snap.docs) {
            const data = d.data();
            // Fetch opportunity details
            let title = 'Volunteer Activity';
            let ngoName = '';
            try {
                const oppDoc = await getDoc(doc(db, 'opportunities', data.opportunityId));
                if (oppDoc.exists()) {
                    title   = oppDoc.data().title   || title;
                    ngoName = oppDoc.data().ngoName || '';
                }
            } catch (_) {}

            const dateKey = data.appliedAt
                ? new Date(data.appliedAt).toISOString().split('T')[0]
                : null;

            const entry = {
                id: d.id,
                title,
                ngoName,
                status:    data.status || 'pending',
                appliedAt: data.appliedAt,
                dateKey
            };

            enriched.push(entry);

            if (dateKey) {
                if (!eventMap[dateKey]) eventMap[dateKey] = [];
                eventMap[dateKey].push(entry);
            }
        }

        // Sort newest first
        allApps = enriched.sort((a, b) => new Date(b.appliedAt) - new Date(a.appliedAt));

        // Update stats
        document.getElementById('statTotal').textContent    = allApps.length;
        document.getElementById('statApproved').textContent = allApps.filter(a => a.status === 'approved').length;
        document.getElementById('statPending').textContent  = allApps.filter(a => a.status === 'pending').length;

        // Init calendar to today
        const today = new Date();
        viewYear  = today.getFullYear();
        viewMonth = today.getMonth();
        renderCalendar();
        renderTimeline();

    } catch (e) {
        console.error(e);
        document.getElementById('appTimeline').innerHTML =
            `<p style="color:#e53e3e;font-size:13px">Error loading: ${e.message}</p>`;
    }
}

// ─── Render calendar ──────────────────────────────
function renderCalendar() {
    document.getElementById('calMonthLabel').textContent = MONTHS[viewMonth];
    document.getElementById('calYearLabel').textContent  = viewYear;

    // This-month count for stat
    const monthKey = `${viewYear}-${String(viewMonth + 1).padStart(2,'0')}`;
    const monthCount = Object.keys(eventMap)
        .filter(k => k.startsWith(monthKey))
        .reduce((sum, k) => sum + eventMap[k].length, 0);
    document.getElementById('statMonthCount').textContent = monthCount;

    const today     = new Date();
    const todayKey  = today.toISOString().split('T')[0];

    // First day of month, how many days
    const firstDay  = new Date(viewYear, viewMonth, 1).getDay(); // 0=Sun
    const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
    const daysInPrev  = new Date(viewYear, viewMonth, 0).getDate();

    const grid = document.getElementById('calGrid');
    grid.innerHTML = '';

    // Leading empty cells (prev month days)
    for (let i = 0; i < firstDay; i++) {
        const day = daysInPrev - firstDay + 1 + i;
        const cell = makeCell(day, true, false, false, null, []);
        grid.appendChild(cell);
    }

    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dateKey   = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday   = dateKey === todayKey;
        const events    = eventMap[dateKey] || [];
        const hasEvent  = events.length > 0;
        const cell      = makeCell(d, false, isToday, hasEvent, dateKey, events);
        grid.appendChild(cell);
    }

    // Trailing cells
    const totalCells = firstDay + daysInMonth;
    const trailing   = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 1; i <= trailing; i++) {
        const cell = makeCell(i, true, false, false, null, []);
        grid.appendChild(cell);
    }

    lucide.createIcons();
}

function makeCell(dayNum, otherMonth, isToday, hasEvent, dateKey, events) {
    const cell = document.createElement('div');
    cell.classList.add('cal-day');
    if (otherMonth) cell.classList.add('other-month');
    if (isToday)   cell.classList.add('today');
    if (hasEvent)  cell.classList.add('has-event');

    cell.innerHTML = `<span>${dayNum}</span>`;

    // Dots
    if (hasEvent) {
        const dots = document.createElement('div');
        dots.className = 'event-dots';
        const count = Math.min(events.length, 3);
        for (let i = 0; i < count; i++) {
            dots.appendChild(document.createElement('span'));
        }
        cell.appendChild(dots);
    }

    if (hasEvent && dateKey) {
        cell.addEventListener('click', () => showDayPanel(dateKey, events));
    }

    return cell;
}

// ─── Day panel ────────────────────────────────────
function showDayPanel(dateKey, events) {
    const [year, month, day] = dateKey.split('-');
    const label = `${parseInt(day)} ${MONTHS[parseInt(month)-1]} ${year}`;

    document.getElementById('dayPanelTitle').textContent = label;
    document.getElementById('dayEmpty').style.display    = 'none';

    const container = document.getElementById('dayActivities');
    container.innerHTML = '';

    events.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'activity-item';
        item.innerHTML = `
            <div class="activity-top">
                <div class="activity-title">${ev.title}</div>
                <span class="status-pill ${ev.status}">${ev.status}</span>
            </div>
            <div class="activity-ngo">
                <i data-lucide="building-2"></i>
                ${ev.ngoName || 'Organisation'}
            </div>
        `;
        container.appendChild(item);
    });

    lucide.createIcons();
}

// ─── Timeline ─────────────────────────────────────
function renderTimeline() {
    const tl = document.getElementById('appTimeline');

    if (allApps.length === 0) {
        tl.innerHTML = `<div style="text-align:center;padding:20px;color:var(--ink-light);font-size:14px">
            No applications yet — start volunteering!
        </div>`;
        return;
    }

    tl.innerHTML = allApps.map(app => {
        const date = app.appliedAt
            ? new Date(app.appliedAt).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })
            : '—';
        return `
            <div class="timeline-item">
                <div class="tl-dot-wrap">
                    <div class="tl-dot"></div>
                    <div class="tl-line"></div>
                </div>
                <div class="tl-content">
                    <div class="tl-date">${date}</div>
                    <div class="tl-title">${app.title}</div>
                    <div class="tl-ngo">
                        <i data-lucide="building-2"></i>
                        ${app.ngoName || 'Organisation'}
                        <span class="status-pill ${app.status}" style="margin-left:6px">${app.status}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    lucide.createIcons();
}

// ─── Nav buttons ──────────────────────────────────
document.getElementById('prevMonth').addEventListener('click', () => {
    viewMonth--;
    if (viewMonth < 0) { viewMonth = 11; viewYear--; }
    renderCalendar();
});
document.getElementById('nextMonth').addEventListener('click', () => {
    viewMonth++;
    if (viewMonth > 11) { viewMonth = 0; viewYear++; }
    renderCalendar();
});
</script>

</body>
</html>
