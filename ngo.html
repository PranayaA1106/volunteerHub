<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NGO Dashboard</title>

<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>

<nav class="navbar">
    <h2>ğŸ¢ NGO Dashboard</h2>
    <button onclick="logout()" class="btn-secondary">Logout</button>
</nav>

<div class="container">
<div class="ngo-container">

<!-- POST OPPORTUNITY -->
<div class="card">
<h2>ğŸ“ Post New Opportunity</h2>

<form id="opportunityForm">

<div class="form-group">
<label>NGO Name *</label>
<input type="text" id="ngoName" required>
</div>

<div class="form-group">
<label>Opportunity Title *</label>
<input type="text" id="title" required>
</div>

<div class="form-group">
<label>Description *</label>
<textarea id="description" rows="4" required></textarea>
</div>

<div class="form-group">
<label>Required Skills *</label>
<div class="checkbox-grid">
<label><input type="checkbox" name="skills" value="teaching"> Teaching</label>
<label><input type="checkbox" name="skills" value="medical"> Medical</label>
<label><input type="checkbox" name="skills" value="tech"> Technology</label>
<label><input type="checkbox" name="skills" value="design"> Design</label>
<label><input type="checkbox" name="skills" value="writing"> Writing</label>
<label><input type="checkbox" name="skills" value="legal"> Legal</label>
<label><input type="checkbox" name="skills" value="marketing"> Marketing</label>
<label><input type="checkbox" name="skills" value="fundraising"> Fundraising</label>
</div>
</div>

<div class="form-group">
<label>Location</label>
<input type="text" id="ngoLocation" placeholder="Sector 26, Chandigarh">
</div>

<div class="form-group">
<label>Pin NGO Location (Drag marker if needed)</label>
<div id="map" style="height:300px;border-radius:8px;"></div>
</div>

<div class="form-row">
<label><input type="checkbox" id="isMicro"> â± Micro-volunteering</label>
<label><input type="checkbox" id="isUrgent"> ğŸš¨ Urgent</label>
</div>

<button type="submit" class="btn-primary">Post Opportunity</button>
<p class="success-msg" id="successMsg"></p>
<p class="error-msg" id="errorMsg"></p>

</form>
</div>

<!-- MY POSTS -->
<div class="card">
<h2>ğŸ“‹ My Posted Opportunities</h2>
<div id="opportunitiesList"><p class="loading">Loading...</p></div>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
authDomain: "volunteerhub-5c419.firebaseapp.com",
projectId: "volunteerhub-5c419",
storageBucket: "volunteerhub-5c419.firebasestorage.app",
messagingSenderId: "769987727654",
appId: "1:769987727654:web:20f964e64bcae74d8bb1e7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let map, marker, selectedLatLng;

// AUTH
onAuthStateChanged(auth, async (user) => {
if (!user) return location.href = "index.html";

currentUser = user;
const userDoc = await getDoc(doc(db, "users", user.uid));

if (!userDoc.exists() || userDoc.data().role !== "ngo")
return location.href = "index.html";

loadOpportunities();
setTimeout(initMap, 300);
});

window.logout = async () => {
await signOut(auth);
location.href = "index.html";
};

// MAP
function initMap() {
if (map) map.remove();

map = L.map("map").setView([30.7333, 76.7794], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

marker = L.marker([30.7333, 76.7794], { draggable: true }).addTo(map);
selectedLatLng = marker.getLatLng();

marker.on("dragend", () => {
selectedLatLng = marker.getLatLng();
});
}

async function geocodeAddress(address) {
const res = await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`,
{ headers: { "User-Agent": "VolunteerHub" } }
);
const data = await res.json();
if (!data.length) return null;
return { lat: +data[0].lat, lng: +data[0].lon };
}

// MOVE MAP ON LOCATION INPUT
document.getElementById("ngoLocation").addEventListener("blur", async () => {
const value = ngoLocation.value;
if (!value || value.toLowerCase() === "remote") return;

const coords = await geocodeAddress(value);
if (!coords) return alert("Location not found");

map.setView([coords.lat, coords.lng], 15);
marker.setLatLng([coords.lat, coords.lng]);
selectedLatLng = marker.getLatLng();
});

// SUBMIT
opportunityForm.addEventListener("submit", async (e) => {
e.preventDefault();

const skills = [...document.querySelectorAll("input[name='skills']:checked")].map(cb => cb.value);
if (!skills.length) return errorMsg.textContent = "Select skills";

const locationValue = ngoLocation.value;

const data = {
ngoName: ngoName.value,
title: title.value,
description: description.value,
skills,
location: locationValue && selectedLatLng ? {
address: locationValue,
lat: selectedLatLng.lat,
lng: selectedLatLng.lng
} : null,
micro: isMicro.checked,
urgent: isUrgent.checked,
ngoId: currentUser.uid,
createdAt: new Date().toISOString()
};

await addDoc(collection(db, "opportunities"), data);
successMsg.textContent = "âœ… Opportunity Posted";
e.target.reset();
loadOpportunities();
});

// LOAD
async function loadOpportunities() {
const snap = await getDocs(query(collection(db,"opportunities"), where("ngoId","==",currentUser.uid)));
opportunitiesList.innerHTML = snap.empty ? "No posts yet" : "";
snap.forEach(d => {
const o = d.data();
opportunitiesList.innerHTML += `
<div class="opportunity-item">
<h3>${o.title}</h3>
<p>${o.description}</p>
<p><strong>Location:</strong> ${o.location?.address || "Remote"}</p>
<button onclick="deleteOpportunity('${d.id}')">Delete</button>
</div>`;
});
}

window.deleteOpportunity = async id => {
await deleteDoc(doc(db,"opportunities",id));
loadOpportunities();
};
</script>

</body>
</html>
