<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Dashboard â€” VolunteerHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --teal-deep:#2d6a75; --teal-mid:#4e9aa6; --teal-soft:#b8dde3; --teal-pale:#e8f5f7;
    --orange-mid:#f0a070; --orange-deep:#d4743a; --orange-pale:#fef6f0; --blush:#f9d4bc;
    --green:#2d8a5e; --green-pale:#f0faf5; --green-soft:#a7f0c8;
    --red:#c53030; --red-pale:#fff5f5; --red-soft:#fecaca;
    --cream:#faf8f5; --ink:#1c2b2e; --ink-mid:#3d5457; --ink-light:#7a9498;
    --border:#ddeaec; --white:#ffffff; --sidebar-w:260px;
}
html { scroll-behavior: smooth; }
body { font-family:'DM Sans',sans-serif; background:var(--cream); color:var(--ink); min-height:100vh; display:flex; }

/* SIDEBAR */
.sidebar {
    width:var(--sidebar-w); min-height:100vh;
    background:linear-gradient(160deg,var(--teal-deep) 0%,var(--teal-mid) 100%);
    border-radius:0 36px 36px 0; padding:36px 24px;
    display:flex; flex-direction:column; justify-content:space-between;
    position:sticky; top:0; height:100vh;
    box-shadow:6px 0 40px rgba(45,106,117,0.18); z-index:100; flex-shrink:0;
}
.sidebar-logo { margin-bottom:44px; }
.sidebar-logo img { width:148px; height:auto; }
.sidebar-logo .wordmark { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:600; color:white; margin-top:4px; }
.nav-links { display:flex; flex-direction:column; gap:4px; }
.nav-item {
    color:rgba(255,255,255,0.72); text-decoration:none;
    display:flex; align-items:center; gap:12px;
    padding:13px 16px; border-radius:16px;
    font-size:14px; font-weight:500; cursor:pointer;
    transition:all 0.25s ease; position:relative;
    border:none; background:none; width:100%; text-align:left;
    font-family:'DM Sans',sans-serif;
}
.nav-item svg { width:17px; height:17px; flex-shrink:0; }
.nav-item:hover { background:rgba(255,255,255,0.12); color:white; transform:translateX(4px); }
.nav-item.active { background:white; color:var(--teal-deep); font-weight:600; box-shadow:0 6px 20px rgba(0,0,0,0.12); }
.nav-badge {
    margin-left:auto; background:var(--orange-mid); color:white;
    font-size:10px; font-weight:700; width:19px; height:19px;
    border-radius:50%; display:none; align-items:center; justify-content:center;
}
.sidebar-footer { border-top:1px solid rgba(255,255,255,0.15); padding-top:20px; }
.sidebar-ngo-name { font-size:12px; font-weight:600; color:rgba(255,255,255,0.7); margin-bottom:10px; padding:0 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.logout-btn {
    width:100%; padding:12px; background:rgba(255,255,255,0.1);
    color:white; border:1px solid rgba(255,255,255,0.2); border-radius:14px;
    font-family:'DM Sans',sans-serif; font-size:14px; font-weight:500; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.25s;
}
.logout-btn svg { width:15px; height:15px; }
.logout-btn:hover { background:rgba(255,255,255,0.2); }

/* MAIN */
.main-content { flex:1; overflow-y:auto; min-height:100vh; }
.section { display:none; padding:40px 48px; animation:fadeUp 0.4s ease; }
.section.active { display:block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
@keyframes spin { to{transform:rotate(360deg)} }

/* PAGE HEADER */
.page-header { margin-bottom:32px; }
.page-header .eyebrow { font-size:11px; font-weight:600; letter-spacing:2.5px; text-transform:uppercase; color:var(--orange-mid); margin-bottom:8px; }
.page-header h1 { font-family:'Cormorant Garamond',serif; font-size:44px; font-weight:600; line-height:1.1; color:var(--ink); }
.page-header h1 em { font-style:italic; color:var(--teal-mid); }

/* STATS */
.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:32px; }
.stat-card {
    background:white; border-radius:22px; padding:24px 20px;
    border:1.5px solid var(--border); box-shadow:0 4px 20px rgba(45,106,117,0.05); transition:all 0.25s;
}
.stat-card:hover { transform:translateY(-4px); box-shadow:0 12px 32px rgba(45,106,117,0.1); }
.stat-icon { width:42px; height:42px; border-radius:13px; display:flex; align-items:center; justify-content:center; margin-bottom:14px; }
.stat-icon svg { width:20px; height:20px; }
.stat-icon.teal   { background:var(--teal-pale);   color:var(--teal-deep); }
.stat-icon.orange { background:var(--orange-pale); color:var(--orange-deep); }
.stat-icon.green  { background:var(--green-pale);  color:var(--green); }
.stat-icon.blue   { background:#eff6ff; color:#2563eb; }
.stat-val { font-size:34px; font-weight:700; color:var(--ink); line-height:1; }
.stat-label { font-size:13px; color:var(--ink-light); margin-top:5px; }

/* TWO COL */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:24px; }

/* CARD */
.card { background:white; border-radius:24px; padding:28px; border:1px solid var(--border); box-shadow:0 4px 20px rgba(45,106,117,0.05); }
.card-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.card-head-left { display:flex; align-items:center; gap:10px; }
.card-head-left svg { width:19px; height:19px; color:var(--teal-mid); }
.card-head h2 { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:600; color:var(--ink); }
.card-count { font-size:12px; font-weight:600; background:var(--orange-pale); color:var(--orange-deep); border:1px solid var(--blush); border-radius:99px; padding:3px 11px; }

/* APP LIST */
.app-list { display:flex; flex-direction:column; gap:10px; max-height:440px; overflow-y:auto; padding-right:2px; }
.app-list::-webkit-scrollbar { width:4px; }
.app-list::-webkit-scrollbar-track { background:var(--teal-pale); border-radius:99px; }
.app-list::-webkit-scrollbar-thumb { background:var(--teal-soft); border-radius:99px; }
.app-item {
    display:flex; align-items:center; gap:14px;
    padding:14px 16px; border-radius:14px; border:1.5px solid var(--border);
    transition:all 0.2s; animation:fadeUp 0.3s ease both;
}
.app-item:hover { background:var(--teal-pale); border-color:var(--teal-soft); }
.app-item.unread { border-color:var(--orange-mid); background:var(--orange-pale); }
.app-avatar { width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--teal-mid),var(--orange-mid)); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; font-weight:700; flex-shrink:0; }
.app-body { flex:1; min-width:0; }
.app-name { font-size:14px; font-weight:600; color:var(--ink); }
.app-opp  { font-size:12px; color:var(--ink-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
.app-meta { font-size:11px; color:var(--ink-light); margin-top:3px; }
.app-status { font-size:11px; font-weight:600; padding:4px 10px; border-radius:99px; white-space:nowrap; flex-shrink:0; }
.app-status.pending  { background:var(--orange-pale); color:var(--orange-deep); border:1px solid var(--blush); }
.app-status.approved { background:var(--green-pale);  color:var(--green);       border:1px solid var(--green-soft); }
.app-status.rejected { background:var(--red-pale);    color:var(--red);         border:1px solid var(--red-soft); }
.app-actions { display:flex; flex-direction:column; gap:5px; flex-shrink:0; }
.btn-sm { padding:6px 12px; border-radius:8px; border:none; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; transition:all 0.2s; white-space:nowrap; }
.btn-sm svg { width:12px; height:12px; }
.btn-approve { background:var(--green-pale); color:var(--green); border:1px solid var(--green-soft); }
.btn-approve:hover { background:var(--green); color:white; }
.btn-reject  { background:var(--red-pale);   color:var(--red);   border:1px solid var(--red-soft); }
.btn-reject:hover  { background:var(--red);   color:white; }

/* OPP LIST */
.opp-list { display:flex; flex-direction:column; gap:10px; max-height:440px; overflow-y:auto; }
.opp-list::-webkit-scrollbar { width:4px; }
.opp-list::-webkit-scrollbar-track { background:var(--teal-pale); border-radius:99px; }
.opp-list::-webkit-scrollbar-thumb { background:var(--teal-soft); border-radius:99px; }
.opp-item { padding:14px 16px; border-radius:14px; border:1.5px solid var(--border); background:white; display:flex; align-items:flex-start; gap:12px; transition:all 0.2s; }
.opp-item:hover { border-color:var(--teal-mid); box-shadow:0 4px 16px rgba(45,106,117,0.08); }
.opp-cat-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; margin-top:5px; background:linear-gradient(135deg,var(--teal-mid),var(--orange-mid)); }
.opp-body { flex:1; min-width:0; }
.opp-title { font-size:14px; font-weight:600; color:var(--ink); margin-bottom:4px; }
.opp-meta  { font-size:12px; color:var(--ink-light); display:flex; gap:10px; flex-wrap:wrap; }
.opp-meta span { display:flex; align-items:center; gap:4px; }
.opp-meta svg  { width:12px; height:12px; }
.btn-delete { padding:6px 10px; border-radius:8px; background:var(--red-pale); color:var(--red); border:1px solid var(--red-soft); font-family:'DM Sans',sans-serif; font-size:12px; font-weight:600; cursor:pointer; flex-shrink:0; display:flex; align-items:center; gap:4px; transition:all 0.2s; }
.btn-delete svg { width:13px; height:13px; }
.btn-delete:hover { background:var(--red); color:white; }

/* EMPTY */
.empty-state { text-align:center; padding:40px 20px; color:var(--ink-light); }
.empty-icon { width:52px; height:52px; background:var(--teal-pale); border-radius:16px; display:flex; align-items:center; justify-content:center; margin:0 auto 12px; }
.empty-icon svg { width:24px; height:24px; color:var(--teal-mid); }
.empty-state h3 { font-size:16px; color:var(--ink-mid); margin-bottom:5px; }
.empty-state p { font-size:13px; }
.spinner { width:30px; height:30px; border:3px solid var(--border); border-top-color:var(--teal-mid); border-radius:50%; animation:spin 0.7s linear infinite; margin:32px auto; }
.spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,0.35); border-top-color:white; border-radius:50%; animation:spin 0.6s linear infinite; flex-shrink:0; }

/* POST FORM */
.form-wrap { max-width:760px; }
.form-section-label { font-size:11px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--ink-light); margin:28px 0 14px; display:flex; align-items:center; gap:10px; }
.form-section-label::after { content:''; flex:1; height:1px; background:var(--border); }
.fields-grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.field-full { grid-column:1/-1; }
.field { display:flex; flex-direction:column; gap:7px; }
.field label { font-size:13px; font-weight:600; color:var(--ink-mid); }
.input-wrap { position:relative; display:flex; align-items:center; }
.input-wrap .fi { position:absolute; left:14px; width:16px; height:16px; color:var(--ink-light); pointer-events:none; }
.input-wrap input,.input-wrap select,.input-wrap textarea { width:100%; padding:12px 14px 12px 42px; border:1.5px solid var(--border); border-radius:14px; font-family:'DM Sans',sans-serif; font-size:14px; color:var(--ink); background:white; transition:border 0.22s,box-shadow 0.22s; resize:none; appearance:none; }
.input-wrap textarea { padding-top:14px; min-height:100px; }
.input-wrap input:focus,.input-wrap select:focus,.input-wrap textarea:focus { outline:none; border-color:var(--teal-mid); box-shadow:0 0 0 3px rgba(78,154,166,0.12); }
.input-wrap input::placeholder,.input-wrap textarea::placeholder { color:var(--ink-light); }
.select-arr { position:absolute; right:14px; pointer-events:none; color:var(--ink-light); }
.select-arr svg { width:14px; height:14px; }

/* CHIPS */
.chip-grid { display:flex; flex-wrap:wrap; gap:9px; }
.chip { display:flex; align-items:center; gap:7px; padding:9px 15px; border-radius:99px; border:1.5px solid var(--border); background:white; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; color:var(--ink-mid); cursor:pointer; transition:all 0.2s; user-select:none; }
.chip input { display:none; }
.chip svg { width:14px; height:14px; color:var(--ink-light); transition:color 0.2s; }
.chip:hover { border-color:var(--teal-mid); background:var(--teal-pale); color:var(--teal-deep); }
.chip:hover svg { color:var(--teal-mid); }
.chip.selected { border-color:var(--teal-mid); background:var(--teal-pale); color:var(--teal-deep); font-weight:600; }
.chip.selected svg { color:var(--teal-mid); }

/* TOGGLES */
.toggle-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.toggle-card { border:1.5px solid var(--border); border-radius:16px; padding:16px 18px; cursor:pointer; display:flex; align-items:center; gap:12px; background:white; transition:all 0.22s; user-select:none; }
.toggle-card input { display:none; }
.toggle-icon { width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.22s; }
.toggle-icon svg { width:18px; height:18px; }
.toggle-icon.micro  { background:var(--teal-pale);   color:var(--teal-mid); }
.toggle-icon.urgent { background:var(--orange-pale); color:var(--orange-deep); }
.toggle-text .t-title { font-size:14px; font-weight:600; color:var(--ink); display:block; }
.toggle-text .t-desc  { font-size:12px; color:var(--ink-light); }
.toggle-card.selected { border-color:var(--teal-mid); background:var(--teal-pale); }
.toggle-card.selected .toggle-icon.micro  { background:var(--teal-mid);   color:white; }
.toggle-card.selected .toggle-icon.urgent { background:var(--orange-mid); color:white; }

/* MAP */
#map { height:260px; border-radius:16px; border:1.5px solid var(--border); margin-top:8px; z-index:1; }

/* SUBMIT */
.btn-post-submit { padding:15px 36px; background:linear-gradient(135deg,var(--teal-mid),var(--orange-mid)); color:white; border:none; border-radius:16px; font-family:'DM Sans',sans-serif; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:10px; transition:all 0.25s; margin-top:28px; }
.btn-post-submit svg { width:18px; height:18px; }
.btn-post-submit:hover { transform:translateY(-2px); box-shadow:0 12px 28px rgba(78,154,166,0.28); }
.btn-post-submit:disabled { opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none; }
.form-msg { margin-top:14px; padding:12px 16px; border-radius:12px; font-size:13px; font-weight:500; display:none; align-items:center; gap:8px; }
.form-msg.success { background:var(--green-pale); color:var(--green); border:1px solid var(--green-soft); display:flex; }
.form-msg.error   { background:var(--red-pale);   color:var(--red);   border:1px solid var(--red-soft);   display:flex; }
.form-msg svg { width:16px; height:16px; flex-shrink:0; }

/* CALENDAR */
.cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
.cal-nav { display:flex; align-items:center; gap:10px; }
.cal-nav button { width:34px; height:34px; border-radius:10px; border:1.5px solid var(--border); background:white; color:var(--ink-mid); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.cal-nav button svg { width:15px; height:15px; }
.cal-nav button:hover { border-color:var(--teal-mid); color:var(--teal-mid); }
.cal-month { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:600; color:var(--ink); }
.cal-legend { display:flex; gap:14px; font-size:12px; font-weight:600; color:var(--ink-light); flex-wrap:wrap; }
.cal-legend span { display:flex; align-items:center; gap:5px; }
.leg-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:3px; }
.cal-day-header { text-align:center; font-size:10px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--ink-light); padding:8px 0; }
.cal-cell { min-height:60px; border-radius:11px; border:1px solid transparent; padding:5px; cursor:pointer; transition:all 0.18s; }
.cal-cell:hover { background:var(--teal-pale); border-color:var(--teal-soft); }
.cal-cell.today { background:var(--teal-pale); border-color:var(--teal-mid); }
.cal-cell.other-month { opacity:0.3; }
.cal-date { font-size:12px; font-weight:600; color:var(--ink-mid); display:flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:7px; }
.cal-cell.today .cal-date { background:var(--teal-mid); color:white; }
.cal-dot { display:block; width:5px; height:5px; border-radius:50%; margin:2px auto 0; }
.cal-dot.pending  { background:var(--orange-mid); }
.cal-dot.approved { background:var(--green); }
.cal-dot.deadline { background:var(--red); }
.cal-events-label { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--ink-light); margin:0 0 12px; }
.cal-event-list { display:flex; flex-direction:column; gap:8px; max-height:380px; overflow-y:auto; }
.cal-event-item { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:13px; border:1.5px solid var(--border); background:white; font-size:13px; transition:all 0.2s; }
.cal-event-item:hover { border-color:var(--teal-soft); background:var(--teal-pale); }
.cal-event-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.cal-event-dot.pending  { background:var(--orange-mid); }
.cal-event-dot.approved { background:var(--green); }
.cal-event-dot.deadline { background:var(--red); }
.cal-event-title { font-weight:600; color:var(--ink); flex:1; }
.cal-event-sub   { font-size:12px; color:var(--ink-light); }

/* TOAST */
.toast { position:fixed; bottom:32px; right:32px; background:white; border-radius:18px; padding:16px 20px; display:flex; align-items:center; gap:14px; box-shadow:0 16px 48px rgba(0,0,0,0.14); border:1.5px solid var(--border); z-index:9999; max-width:320px; transform:translateY(100px); opacity:0; transition:all 0.4s cubic-bezier(0.22,1,0.36,1); }
.toast.show { transform:translateY(0); opacity:1; }
.toast-icon { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.toast-icon svg { width:18px; height:18px; }
.toast-icon.success { background:var(--green-pale); color:var(--green); }
.toast-icon.error   { background:var(--red-pale);   color:var(--red); }
.toast-icon.info    { background:var(--teal-pale);  color:var(--teal-mid); }
.toast-title { font-size:13px; font-weight:600; color:var(--ink); }
.toast-msg   { font-size:12px; color:var(--ink-light); margin-top:2px; }

/* RESPONSIVE */
@media(max-width:1100px) { .stats-row{grid-template-columns:repeat(2,1fr)} .two-col{grid-template-columns:1fr} }
@media(max-width:900px) { .section{padding:28px 24px} .page-header h1{font-size:34px} }
@media(max-width:680px) {
    body{flex-direction:column}
    .sidebar{width:100%;min-height:unset;height:auto;border-radius:0 0 28px 28px;position:relative;padding:18px;flex-direction:row;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .sidebar-logo{margin-bottom:0} .sidebar-logo img{width:100px}
    .nav-links{flex-direction:row;flex-wrap:wrap;gap:4px}
    .nav-item{padding:8px 10px;font-size:12px}
    .nav-item:hover{transform:none}
    .sidebar-footer{border-top:none;padding-top:0}
    .stats-row{grid-template-columns:repeat(2,1fr)}
    .fields-grid{grid-template-columns:1fr}
    .toggle-grid{grid-template-columns:1fr}
    .section{padding:24px 16px}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
    <div>
        <div class="sidebar-logo">
            <img src="images/volunteerhub-logo.png" alt="VolunteerHub" onerror="this.style.display='none'">
            <div class="wordmark">VolunteerHub</div>
        </div>
        <nav class="nav-links">
            <button class="nav-item active" onclick="showSection('dashboard')">
                <i data-lucide="layout-dashboard"></i> Dashboard
            </button>
            <button class="nav-item" onclick="showSection('applications')">
                <i data-lucide="users"></i> Applications
                <span class="nav-badge" id="appBadge"></span>
            </button>
            <button class="nav-item" onclick="showSection('opportunities')">
                <i data-lucide="briefcase"></i> Opportunities
            </button>
            <button class="nav-item" onclick="showSection('post')">
                <i data-lucide="plus-circle"></i> Post New
            </button>
            <button class="nav-item" onclick="showSection('calendar')">
                <i data-lucide="calendar"></i> Calendar
            </button>
        </nav>
    </div>
    <div class="sidebar-footer">
        <div class="sidebar-ngo-name" id="sidebarNgoName">â€¦</div>
        <button onclick="doLogout()" class="logout-btn">
            <i data-lucide="log-out"></i> Logout
        </button>
    </div>
</aside>

<!-- MAIN -->
<main class="main-content">

    <!-- DASHBOARD -->
    <div class="section active" id="dashboard">
        <div class="page-header">
            <p class="eyebrow">NGO Dashboard</p>
            <h1>Welcome, <em id="ngoNameHeader">â€¦</em></h1>
        </div>
        <div class="stats-row">
            <div class="stat-card"><div class="stat-icon teal"><i data-lucide="briefcase"></i></div><div class="stat-val" id="statOpps">â€”</div><div class="stat-label">Active Opportunities</div></div>
            <div class="stat-card"><div class="stat-icon orange"><i data-lucide="users"></i></div><div class="stat-val" id="statApps">â€”</div><div class="stat-label">Total Applicants</div></div>
            <div class="stat-card"><div class="stat-icon green"><i data-lucide="check-circle"></i></div><div class="stat-val" id="statApproved">â€”</div><div class="stat-label">Approved</div></div>
            <div class="stat-card"><div class="stat-icon blue"><i data-lucide="clock"></i></div><div class="stat-val" id="statPending">â€”</div><div class="stat-label">Pending Review</div></div>
        </div>
        <div class="two-col">
            <div class="card">
                <div class="card-head">
                    <div class="card-head-left"><i data-lucide="bell"></i><h2>Recent Applications</h2></div>
                    <span class="card-count" id="dashAppCount">0 new</span>
                </div>
                <div id="dashAppList"><div class="spinner"></div></div>
            </div>
            <div class="card">
                <div class="card-head">
                    <div class="card-head-left"><i data-lucide="briefcase"></i><h2>My Opportunities</h2></div>
                    <button onclick="showSection('post')" style="padding:6px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--teal-mid),var(--orange-mid));color:white;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:5px;"><i data-lucide="plus" style="width:13px;height:13px;"></i> Post New</button>
                </div>
                <div id="dashOppList"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- APPLICATIONS -->
    <div class="section" id="applications">
        <div class="page-header">
            <p class="eyebrow">Volunteer Management</p>
            <h1>All <em>Applications</em></h1>
        </div>
        <div class="card">
            <div class="card-head">
                <div class="card-head-left"><i data-lucide="users"></i><h2>Applicant List</h2></div>
                <span class="card-count" id="allAppCount">â€”</span>
            </div>
            <div id="allAppList"><div class="spinner"></div></div>
        </div>
    </div>

    <!-- OPPORTUNITIES -->
    <div class="section" id="opportunities">
        <div class="page-header">
            <p class="eyebrow">Your Listings</p>
            <h1>Posted <em>Opportunities</em></h1>
        </div>
        <div class="card">
            <div class="card-head">
                <div class="card-head-left"><i data-lucide="briefcase"></i><h2>All Listings</h2></div>
                <button onclick="showSection('post')" style="padding:6px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--teal-mid),var(--orange-mid));color:white;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:5px;"><i data-lucide="plus" style="width:13px;height:13px;"></i> Post New</button>
            </div>
            <div id="allOppList"><div class="spinner"></div></div>
        </div>
    </div>

    <!-- POST NEW -->
    <div class="section" id="post">
        <div class="page-header">
            <p class="eyebrow">Create Listing</p>
            <h1>Post an <em>Opportunity</em></h1>
        </div>
        <div class="form-wrap">
            <form id="opportunityForm" novalidate>
                <p class="form-section-label">Basic Info</p>
                <div class="fields-grid">
                    <div class="field">
                        <label>Opportunity Title *</label>
                        <div class="input-wrap"><i data-lucide="file-text" class="fi"></i><input type="text" id="ftitle" placeholder="e.g., Online Math Tutors Needed" required></div>
                    </div>
                    <div class="field">
                        <label>Category *</label>
                        <div class="input-wrap">
                            <i data-lucide="tag" class="fi"></i>
                            <select id="fcategory" required>
                                <option value="">Select Category</option>
                                <option>Education</option><option>Environment</option>
                                <option>Health</option><option>Community</option>
                                <option>Animals</option><option>Disaster Relief</option>
                            </select>
                            <span class="select-arr"><i data-lucide="chevron-down"></i></span>
                        </div>
                    </div>
                    <div class="field field-full">
                        <label>Description *</label>
                        <div class="input-wrap" style="align-items:flex-start;">
                            <i data-lucide="align-left" class="fi" style="top:14px;"></i>
                            <textarea id="fdescription" placeholder="Describe what volunteers will do and the impact they'll makeâ€¦" required></textarea>
                        </div>
                    </div>
                    <div class="field">
                        <label>Volunteers Needed *</label>
                        <div class="input-wrap"><i data-lucide="users" class="fi"></i><input type="number" id="fslots" placeholder="e.g. 5" min="1" required></div>
                    </div>
                    <div class="field">
                        <label>Application Deadline *</label>
                        <div class="input-wrap"><i data-lucide="calendar" class="fi"></i><input type="date" id="fdeadline" required></div>
                    </div>
                    <div class="field field-full">
                        <label>Location / Address *</label>
                        <div class="input-wrap"><i data-lucide="map-pin" class="fi"></i><input type="text" id="flocation" placeholder="City, address or 'Remote'" required></div>
                    </div>
                </div>

                <p class="form-section-label">Required Skills</p>
                <div class="chip-grid">
                    <label class="chip"><input type="checkbox" name="skills" value="teaching"><i data-lucide="book-open"></i> Teaching</label>
                    <label class="chip"><input type="checkbox" name="skills" value="medical"><i data-lucide="heart-pulse"></i> Medical</label>
                    <label class="chip"><input type="checkbox" name="skills" value="tech"><i data-lucide="code-2"></i> Technology</label>
                    <label class="chip"><input type="checkbox" name="skills" value="design"><i data-lucide="pen-tool"></i> Design</label>
                    <label class="chip"><input type="checkbox" name="skills" value="writing"><i data-lucide="pencil"></i> Writing</label>
                    <label class="chip"><input type="checkbox" name="skills" value="legal"><i data-lucide="scale"></i> Legal</label>
                    <label class="chip"><input type="checkbox" name="skills" value="marketing"><i data-lucide="megaphone"></i> Marketing</label>
                    <label class="chip"><input type="checkbox" name="skills" value="fundraising"><i data-lucide="hand-coins"></i> Fundraising</label>
                    <label class="chip"><input type="checkbox" name="skills" value="cooking"><i data-lucide="utensils"></i> Cooking</label>
                    <label class="chip"><input type="checkbox" name="skills" value="logistics"><i data-lucide="truck"></i> Logistics</label>
                </div>

                <p class="form-section-label">Special Options</p>
                <div class="toggle-grid">
                    <label class="toggle-card" id="microCard">
                        <input type="checkbox" id="isMicro">
                        <span class="toggle-icon micro"><i data-lucide="zap"></i></span>
                        <span class="toggle-text"><span class="t-title">Micro-volunteering</span><span class="t-desc">Tasks under 60 mins</span></span>
                    </label>
                    <label class="toggle-card" id="urgentCard">
                        <input type="checkbox" id="isUrgent">
                        <span class="toggle-icon urgent"><i data-lucide="triangle-alert"></i></span>
                        <span class="toggle-text"><span class="t-title">Urgent Need</span><span class="t-desc">Immediate help required</span></span>
                    </label>
                </div>

                <p class="form-section-label">Pin on Map</p>
                <div id="map"></div>
                <p style="font-size:12px;color:var(--ink-light);margin-top:6px;">Type an address above to auto-pin, or drag the marker manually.</p>

                <button type="submit" class="btn-post-submit" id="postBtn">
                    <i data-lucide="send"></i> Post Opportunity
                </button>
                <div class="form-msg" id="postMsg"></div>
            </form>
        </div>
    </div>

    <!-- CALENDAR -->
    <div class="section" id="calendar">
        <div class="page-header">
            <p class="eyebrow">Schedule Overview</p>
            <h1>Volunteer <em>Calendar</em></h1>
        </div>
        <div class="two-col" style="align-items:start;">
            <div class="card">
                <div class="cal-header">
                    <div class="cal-nav">
                        <button onclick="calNav(-1)"><i data-lucide="chevron-left"></i></button>
                        <span class="cal-month" id="calMonthLabel"></span>
                        <button onclick="calNav(1)"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="cal-legend">
                        <span><span class="leg-dot" style="background:var(--orange-mid)"></span> Applied</span>
                        <span><span class="leg-dot" style="background:var(--green)"></span> Approved</span>
                        <span><span class="leg-dot" style="background:var(--red)"></span> Deadline</span>
                    </div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
            </div>
            <div class="card">
                <div class="card-head">
                    <div class="card-head-left"><i data-lucide="list"></i><h2>Events This Month</h2></div>
                </div>
                <p class="cal-events-label" id="calEventsLabel">Loadingâ€¦</p>
                <div id="calEventList"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

</main>

<!-- TOAST -->
<div class="toast" id="toast">
    <div class="toast-icon success" id="toastIcon"><i data-lucide="check-circle"></i></div>
    <div>
        <div class="toast-title" id="toastTitle">Done</div>
        <div class="toast-msg"   id="toastMsg"></div>
    </div>
</div>

<script>
lucide.createIcons();

// Chip toggles
document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
        const cb = chip.querySelector('input');
        cb.checked = !cb.checked;
        chip.classList.toggle('selected', cb.checked);
    });
});

// Toggle cards
['microCard','urgentCard'].forEach(id => {
    const card = document.getElementById(id);
    card?.addEventListener('click', () => {
        const cb = card.querySelector('input');
        cb.checked = !cb.checked;
        card.classList.toggle('selected', cb.checked);
    });
});

// Section nav
function setNav(id) {
    const map2 = {dashboard:0,applications:1,opportunities:2,post:3,calendar:4};
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const items = document.querySelectorAll('.nav-item');
    if (items[map2[id]] !== undefined) items[map2[id]].classList.add('active');
}

window.showSection = function(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
    setNav(id);
    if (id === 'post')          setTimeout(initMap, 80);
    if (id === 'calendar')      { renderCalendar(); renderCalendarEvents(); }
    if (id === 'applications')  renderAllApps();
    if (id === 'opportunities') renderAllOpps();
};

// Toast
function toast(title, msg, type='success') {
    const icons = {success:'check-circle', error:'alert-circle', info:'info'};
    document.getElementById('toastIcon').className = `toast-icon ${type}`;
    document.getElementById('toastIcon').innerHTML = `<i data-lucide="${icons[type]||'info'}"></i>`;
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastMsg').textContent   = msg;
    lucide.createIcons();
    const el = document.getElementById('toast');
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 4000);
}

function formMsg(text, type) {
    const el = document.getElementById('postMsg');
    el.className = `form-msg ${type}`;
    el.innerHTML = `<i data-lucide="${type==='success'?'check-circle':'alert-circle'}"></i> ${text}`;
    lucide.createIcons();
}

function setPostLoading(loading) {
    const btn = document.getElementById('postBtn');
    if (loading) { btn.disabled=true; btn.innerHTML=`<div class="spinner-sm"></div> Postingâ€¦`; }
    else         { btn.disabled=false; btn.innerHTML=`<i data-lucide="send"></i> Post Opportunity`; lucide.createIcons(); }
}

function emptyState(icon, title, msg) {
    return `<div class="empty-state"><div class="empty-icon"><i data-lucide="${icon}"></i></div><h3>${title}</h3><p>${msg}</p></div>`;
}
</script>

<script type="module">
import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import {
    getFirestore, collection, addDoc, query, where,
    getDocs, doc, getDoc, deleteDoc, updateDoc,
    serverTimestamp, onSnapshot
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey:"AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
    authDomain:"volunteerhub-5c419.firebaseapp.com",
    projectId:"volunteerhub-5c419",
    storageBucket:"volunteerhub-5c419.firebasestorage.app",
    messagingSenderId:"769987727654",
    appId:"1:769987727654:web:20f964e64bcae74d8bb1e7"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

let currentUser = null;
let ngoData     = {};
window._opps    = [];
window._apps    = [];

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async (user) => {
    if (!user) { location.href='index.html'; return; }
    currentUser = user;

    const userDoc = await getDoc(doc(db,'users',user.uid));
    if (!userDoc.exists() || userDoc.data().role !== 'ngo') { location.href='index.html'; return; }

    ngoData = userDoc.data();
    const name = ngoData.name || ngoData.email || 'Your NGO';
    document.getElementById('ngoNameHeader').textContent  = name;
    document.getElementById('sidebarNgoName').textContent = name;

    listenOpportunities();
    listenApplications();
});

window.doLogout = async () => { await signOut(auth); location.href='index.html'; };

// â”€â”€ REAL-TIME: OPPORTUNITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function listenOpportunities() {
    const q = query(collection(db,'opportunities'), where('ngoId','==',currentUser.uid));
    onSnapshot(q, snap => {
        window._opps = snap.docs.map(d=>({id:d.id,...d.data()}));
        document.getElementById('statOpps').textContent = window._opps.length;
        renderDashOpps();
        if (document.getElementById('opportunities').classList.contains('active')) renderAllOpps();
        if (document.getElementById('calendar').classList.contains('active'))      { renderCalendar(); renderCalendarEvents(); }
    });
}

// â”€â”€ REAL-TIME: APPLICATIONS (via notifications) â”€â”€â”€â”€â”€â”€â”€
function listenApplications() {
    // Primary: query by NGO's uid
    const q = query(collection(db,'notifications'), where('recipientId','==',currentUser.uid));
    onSnapshot(q, snap => {
        handleAppsUpdate(snap.docs.map(d=>({id:d.id,...d.data()})));
    }, async err => {
        // Fallback: query by NGO name
        console.warn('uid query blocked, fallback to name:', err.message);
        try {
            const q2 = query(collection(db,'notifications'), where('recipientName','==',ngoData.name||''));
            onSnapshot(q2, snap2 => {
                handleAppsUpdate(snap2.docs.map(d=>({id:d.id,...d.data()})));
            });
        } catch(e2) { console.error(e2); }
    });
}

function handleAppsUpdate(apps) {
    // Only keep NGO-bound notifications (not volunteer-bound ones)
    window._apps = apps.filter(a => !a.recipientRole || a.recipientRole !== 'volunteer');

    const total    = window._apps.length;
    const pending  = window._apps.filter(a => !a.status || a.status==='pending').length;
    const approved = window._apps.filter(a => a.status==='approved').length;
    const unread   = window._apps.filter(a => !a.read).length;

    document.getElementById('statApps').textContent     = total;
    document.getElementById('statPending').textContent  = pending;
    document.getElementById('statApproved').textContent = approved;
    document.getElementById('dashAppCount').textContent = unread > 0 ? `${unread} new` : `${total} total`;

    const badge = document.getElementById('appBadge');
    if (unread > 0) { badge.textContent = unread>9?'9+':unread; badge.style.display='flex'; }
    else badge.style.display = 'none';

    renderDashApps();
    if (document.getElementById('applications').classList.contains('active')) renderAllApps();
    if (document.getElementById('calendar').classList.contains('active'))     { renderCalendar(); renderCalendarEvents(); }
}

// â”€â”€ RENDER: DASHBOARD APPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashApps() {
    const container = document.getElementById('dashAppList');
    const apps = [...window._apps].sort((a,b)=>{
        if(a.read!==b.read) return a.read?1:-1;
        return new Date(b.createdAt)-new Date(a.createdAt);
    }).slice(0,5);

    if (!apps.length) { container.innerHTML=emptyState('inbox','No applications yet','Volunteers will appear here once they apply.'); lucide.createIcons(); return; }
    container.innerHTML = `<div class="app-list">${apps.map(appItemHtml).join('')}</div>`;
    lucide.createIcons();
}

// â”€â”€ RENDER: ALL APPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderAllApps = function() {
    const container = document.getElementById('allAppList');
    document.getElementById('allAppCount').textContent = `${window._apps.length} total`;

    const apps = [...window._apps].sort((a,b)=>{
        if(a.read!==b.read) return a.read?1:-1;
        return new Date(b.createdAt)-new Date(a.createdAt);
    });

    if (!apps.length) { container.innerHTML=emptyState('users','No applications yet','When volunteers apply, they\'ll appear here.'); lucide.createIcons(); return; }
    container.innerHTML = `<div class="app-list">${apps.map(appItemHtml).join('')}</div>`;
    lucide.createIcons();
};

function appItemHtml(n) {
    const initials = (n.volunteerName||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const date     = n.createdAt ? new Date(n.createdAt).toLocaleDateString('en-IN',{day:'numeric',month:'short'}) : '';
    const status   = n.status || 'pending';
    const unread   = !n.read;

    const safeName = (n.volunteerName||'').replace(/'/g,"\\'");
    const safeOpp  = (n.opportunityTitle||'').replace(/'/g,"\\'");

    const actions = status === 'pending'
        ? `<div class="app-actions">
               <button class="btn-sm btn-approve" onclick="approveApp('${n.id}','${n.volunteerId||''}','${safeName}','${safeOpp}')"><i data-lucide="check"></i> Approve</button>
               <button class="btn-sm btn-reject"  onclick="rejectApp('${n.id}','${n.volunteerId||''}','${safeName}','${safeOpp}')"><i data-lucide="x"></i> Reject</button>
           </div>`
        : `<span class="app-status ${status}">${status.charAt(0).toUpperCase()+status.slice(1)}</span>`;

    return `
        <div class="app-item ${unread?'unread':''}" id="ai-${n.id}">
            <div class="app-avatar">${initials}</div>
            <div class="app-body">
                <div class="app-name">${n.volunteerName||'Volunteer'}</div>
                <div class="app-opp">${n.opportunityTitle||'Opportunity'}</div>
                <div class="app-meta">${n.volunteerEmail||''}${date?' Â· '+date:''}</div>
            </div>
            ${actions}
        </div>`;
}

// â”€â”€ APPROVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.approveApp = async (notifId, volunteerId, volunteerName, oppTitle) => {
    try {
        // 1. Mark NGO notification as approved + read
        await updateDoc(doc(db,'notifications',notifId), { status:'approved', read:true });

        // 2. Update the application doc status
        if (volunteerId) {
            const appsSnap = await getDocs(query(collection(db,'applications'), where('volunteerId','==',volunteerId)));
            for (const d of appsSnap.docs) {
                await updateDoc(doc(db,'applications',d.id), { status:'approved' });
            }

            // 3. Send notification TO volunteer so they see it on their dashboard
            await addDoc(collection(db,'notifications'), {
                recipientId:      volunteerId,
                recipientRole:    'volunteer',
                type:             'application_approved',
                opportunityTitle: oppTitle,
                ngoName:          ngoData.name || 'The NGO',
                message:          `Congratulations! Your application for "${oppTitle}" has been approved.`,
                read:             false,
                createdAt:        new Date().toISOString()
            });
        }

        toast('Approved! ðŸŽ‰', `${volunteerName} approved for "${oppTitle}". They've been notified.`, 'success');
    } catch(e) { toast('Error', e.message, 'error'); }
};

// â”€â”€ REJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.rejectApp = async (notifId, volunteerId, volunteerName, oppTitle) => {
    try {
        await updateDoc(doc(db,'notifications',notifId), { status:'rejected', read:true });

        if (volunteerId) {
            const appsSnap = await getDocs(query(collection(db,'applications'), where('volunteerId','==',volunteerId)));
            for (const d of appsSnap.docs) {
                await updateDoc(doc(db,'applications',d.id), { status:'rejected' });
            }

            await addDoc(collection(db,'notifications'), {
                recipientId:      volunteerId,
                recipientRole:    'volunteer',
                type:             'application_rejected',
                opportunityTitle: oppTitle,
                ngoName:          ngoData.name || 'The NGO',
                message:          `Your application for "${oppTitle}" was not selected this time. Keep volunteering!`,
                read:             false,
                createdAt:        new Date().toISOString()
            });
        }

        toast('Application closed', `${volunteerName} has been notified.`, 'info');
    } catch(e) { toast('Error', e.message, 'error'); }
};

// â”€â”€ RENDER: DASHBOARD OPPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashOpps() {
    const container = document.getElementById('dashOppList');
    if (!window._opps.length) { container.innerHTML=emptyState('briefcase','No opportunities yet','Post your first opportunity.'); lucide.createIcons(); return; }
    container.innerHTML = `<div class="opp-list">${window._opps.slice(0,5).map(oppItemHtml).join('')}</div>`;
    lucide.createIcons();
}

// â”€â”€ RENDER: ALL OPPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderAllOpps = function() {
    const container = document.getElementById('allOppList');
    if (!window._opps.length) { container.innerHTML=emptyState('briefcase','No opportunities yet','Post your first opportunity.'); lucide.createIcons(); return; }
    container.innerHTML = `<div class="opp-list">${window._opps.map(oppItemHtml).join('')}</div>`;
    lucide.createIcons();
};

function oppItemHtml(o) {
    const appCount   = window._apps.filter(a=>a.opportunityId===o.id).length;
    const deadline   = o.deadline ? (o.deadline.toDate?o.deadline.toDate():new Date(o.deadline)) : null;
    const deadlineStr = deadline ? deadline.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}) : '';
    return `
        <div class="opp-item">
            <span class="opp-cat-dot"></span>
            <div class="opp-body">
                <div class="opp-title">${o.title}</div>
                <div class="opp-meta">
                    <span><i data-lucide="users"></i> ${appCount} applicant${appCount!==1?'s':''}</span>
                    <span><i data-lucide="tag"></i> ${o.category||'General'}</span>
                    ${deadlineStr?`<span><i data-lucide="calendar"></i> ${deadlineStr}</span>`:''}
                    ${o.urgent?`<span style="color:var(--red);font-weight:600;"><i data-lucide="zap"></i> Urgent</span>`:''}
                </div>
            </div>
            <button class="btn-delete" onclick="deleteOpp('${o.id}')"><i data-lucide="trash-2"></i> Delete</button>
        </div>`;
}

window.deleteOpp = async (id) => {
    if (!confirm('Delete this opportunity? This cannot be undone.')) return;
    try { await deleteDoc(doc(db,'opportunities',id)); toast('Deleted','Opportunity removed.','info'); }
    catch(e) { toast('Error',e.message,'error'); }
};

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let leafletMap, leafletMarker, selectedLatLng;

window.initMap = function() {
    const el = document.getElementById('map');
    if (!el || leafletMap) { if(leafletMap) leafletMap.invalidateSize(); return; }

    leafletMap = L.map('map').setView([30.7333,76.7794],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(leafletMap);
    leafletMarker = L.marker([30.7333,76.7794],{draggable:true}).addTo(leafletMap);
    selectedLatLng = leafletMarker.getLatLng();
    leafletMarker.on('dragend', () => { selectedLatLng = leafletMarker.getLatLng(); });
};

document.getElementById('flocation').addEventListener('blur', async (e) => {
    const val = e.target.value.trim();
    if (!val || val.toLowerCase()==='remote' || !leafletMap) return;
    try {
        const res  = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
        const data = await res.json();
        if (!data.length) return;
        const lat=+data[0].lat, lng=+data[0].lon;
        leafletMap.setView([lat,lng],15);
        leafletMarker.setLatLng([lat,lng]);
        selectedLatLng = {lat,lng};
    } catch(e) { console.warn('Geocode failed',e); }
});

// â”€â”€ POST FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('opportunityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setPostLoading(true);

    const title    = document.getElementById('ftitle').value.trim();
    const desc     = document.getElementById('fdescription').value.trim();
    const category = document.getElementById('fcategory').value;
    const slots    = document.getElementById('fslots').value;
    const deadline = document.getElementById('fdeadline').value;
    const location = document.getElementById('flocation').value.trim();
    const skills   = [...document.querySelectorAll("input[name='skills']:checked")].map(cb=>cb.value);
    const isMicro  = document.getElementById('isMicro').checked;
    const isUrgent = document.getElementById('isUrgent').checked;

    if (!title||!desc||!category||!slots||!deadline||!location) {
        formMsg('Please fill in all required fields.','error'); setPostLoading(false); return;
    }
    if (!skills.length) {
        formMsg('Please select at least one required skill.','error'); setPostLoading(false); return;
    }

    try {
        await addDoc(collection(db,'opportunities'), {
            title, description:desc, category,
            slots:Number(slots),
            deadline: new Date(deadline),
            location: selectedLatLng ? {address:location, lat:selectedLatLng.lat, lng:selectedLatLng.lng} : location,
            skills, micro:isMicro, urgent:isUrgent,
            ngoId:   currentUser.uid,
            ngoName: ngoData.name || currentUser.email,
            createdAt: serverTimestamp(),
            status: 'active'
        });

        formMsg('Opportunity posted! Volunteers can now apply.','success');
        e.target.reset();
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
        document.querySelectorAll('.toggle-card').forEach(c=>c.classList.remove('selected'));
        setPostLoading(false);
        setTimeout(() => showSection('dashboard'), 2000);

    } catch(err) { formMsg(err.message,'error'); setPostLoading(false); }
});

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calYear, calMonth;

function initCal() {
    const now = new Date();
    calYear  = now.getFullYear();
    calMonth = now.getMonth();
}

window.calNav = function(dir) {
    if (calYear===undefined) initCal();
    calMonth += dir;
    if (calMonth>11) { calMonth=0; calYear++; }
    if (calMonth<0)  { calMonth=11; calYear--; }
    renderCalendar(); renderCalendarEvents();
};

window.renderCalendar = function() {
    if (calYear===undefined) initCal();
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('calMonthLabel').textContent = `${months[calMonth]} ${calYear}`;

    // Build date â†’ event type maps
    const pendingDates  = new Set();
    const approvedDates = new Set();
    const deadlineDates = new Set();

    window._apps.forEach(a => {
        if (!a.createdAt) return;
        const d = new Date(a.createdAt);
        const k = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        if (!a.status||a.status==='pending') pendingDates.add(k);
        if (a.status==='approved')           approvedDates.add(k);
    });
    window._opps.forEach(o => {
        if (!o.deadline) return;
        const d = o.deadline.toDate ? o.deadline.toDate() : new Date(o.deadline);
        const k = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        deadlineDates.add(k);
    });

    const firstDay    = new Date(calYear,calMonth,1).getDay();
    const daysInMonth = new Date(calYear,calMonth+1,0).getDate();
    const today       = new Date();
    const days        = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    let html = days.map(d=>`<div class="cal-day-header">${d}</div>`).join('');
    for(let i=0;i<firstDay;i++) html += `<div class="cal-cell other-month"></div>`;

    for(let d=1;d<=daysInMonth;d++) {
        const k = `${calYear}-${calMonth}-${d}`;
        const isToday = d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
        html += `
            <div class="cal-cell ${isToday?'today':''}">
                <div class="cal-date">${d}</div>
                ${pendingDates.has(k) ?'<span class="cal-dot pending"></span>'  :''}
                ${approvedDates.has(k)?'<span class="cal-dot approved"></span>' :''}
                ${deadlineDates.has(k)?'<span class="cal-dot deadline"></span>' :''}
            </div>`;
    }

    document.getElementById('calGrid').innerHTML = html;
};

window.renderCalendarEvents = function() {
    if (calYear===undefined) initCal();
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('calEventsLabel').textContent = `${months[calMonth]} ${calYear}`;

    const events = [];

    window._apps.forEach(a => {
        if (!a.createdAt) return;
        const d = new Date(a.createdAt);
        if (d.getMonth()!==calMonth||d.getFullYear()!==calYear) return;
        const status = a.status||'pending';
        events.push({
            date:d, type:status==='approved'?'approved':'pending',
            title:`${a.volunteerName||'Volunteer'} applied`,
            sub:  a.opportunityTitle||''
        });
    });

    window._opps.forEach(o => {
        if (!o.deadline) return;
        const d = o.deadline.toDate ? o.deadline.toDate() : new Date(o.deadline);
        if (d.getMonth()!==calMonth||d.getFullYear()!==calYear) return;
        events.push({
            date:d, type:'deadline',
            title:`Deadline: ${o.title}`,
            sub: d.toLocaleDateString('en-IN',{day:'numeric',month:'short'})
        });
    });

    events.sort((a,b)=>a.date-b.date);

    const container = document.getElementById('calEventList');
    if (!events.length) {
        container.innerHTML = emptyState('calendar','No events this month','Applications and deadlines will show here.');
        lucide.createIcons(); return;
    }

    container.innerHTML = `<div class="cal-event-list">${events.map(ev=>`
        <div class="cal-event-item">
            <span class="cal-event-dot ${ev.type}"></span>
            <span class="cal-event-title">${ev.title}</span>
            <span class="cal-event-sub">${ev.sub||ev.date.toLocaleDateString('en-IN',{day:'numeric',month:'short'})}</span>
        </div>`).join('')}</div>`;
    lucide.createIcons();
};
</script>
</body>
</html>
