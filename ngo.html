<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <h2>üè¢ NGO Dashboard</h2>
        <button onclick="logout()" class="btn-secondary">Logout</button>
    </nav>

    <div class="container">
        <div class="ngo-container">
            <!-- Post Opportunity Form -->
            <div class="card">
                <h2>üìù Post New Opportunity</h2>
                <form id="opportunityForm">
                    <div class="form-group">
                        <label>NGO Name *</label>
                        <input type="text" id="ngoName" placeholder="Your organization name" required>
                    </div>

                    <div class="form-group">
                        <label>Opportunity Title *</label>
                        <input type="text" id="title" placeholder="e.g., Online Math Tutors Needed" required>
                    </div>

                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="description" placeholder="Describe the opportunity..." rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Required Skills *</label>
                        <div class="checkbox-grid">
                            <label><input type="checkbox" name="skills" value="teaching"> Teaching</label>
                            <label><input type="checkbox" name="skills" value="medical"> Medical</label>
                            <label><input type="checkbox" name="skills" value="tech"> Technology</label>
                            <label><input type="checkbox" name="skills" value="design"> Design</label>
                            <label><input type="checkbox" name="skills" value="writing"> Writing</label>
                            <label><input type="checkbox" name="skills" value="legal"> Legal</label>
                            <label><input type="checkbox" name="skills" value="marketing"> Marketing</label>
                            <label><input type="checkbox" name="skills" value="fundraising"> Fundraising</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="ngoLocation" placeholder="City or 'Remote'">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isMicro">
                                ‚è± Micro-volunteering (30-60 min)
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isUrgent">
                                üö® Emergency/Urgent Need
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Post Opportunity</button>
                    <p class="success-msg" id="successMsg"></p>
                    <p class="error-msg" id="errorMsg"></p>
                </form>
            </div>

            <!-- My Posted Opportunities -->
            <div class="card">
                <h2>üìã My Posted Opportunities</h2>
                <div id="opportunitiesList">
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
  apiKey: "AIzaSyDdTtQm8uDTDrWjgfsTHG5zTIkxhDi1mu8",
  authDomain: "volunteerhub-5c419.firebaseapp.com",
  projectId: "volunteerhub-5c419",
  storageBucket: "volunteerhub-5c419.firebasestorage.app",
  messagingSenderId: "769987727654",
  appId: "1:769987727654:web:20f964e64bcae74d8bb1e7"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists() && userDoc.data().role === 'ngo') {
                    loadOpportunities();
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Logout function
        window.logout = async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        // Post Opportunity Handler
        document.getElementById('opportunityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const successMsg = document.getElementById('successMsg');
            const errorMsg = document.getElementById('errorMsg');
            successMsg.textContent = '';
            errorMsg.textContent = '';

            // Get selected skills
            const skillsCheckboxes = document.querySelectorAll('input[name="skills"]:checked');
            const skills = Array.from(skillsCheckboxes).map(cb => cb.value);

            if (skills.length === 0) {
                errorMsg.textContent = 'Please select at least one required skill';
                return;
            }

            const opportunityData = {
                ngoName: document.getElementById('ngoName').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                skills: skills,
                location: document.getElementById('ngoLocation').value || 'Remote',
                micro: document.getElementById('isMicro').checked,
                urgent: document.getElementById('isUrgent').checked,
                ngoId: currentUser.uid,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            try {
                await addDoc(collection(db, 'opportunities'), opportunityData);
                successMsg.textContent = '‚úÖ Opportunity posted successfully!';
                
                // Reset form
                e.target.reset();
                
                // Reload opportunities list
                loadOpportunities();
            } catch (error) {
                errorMsg.textContent = error.message;
            }
        });

        // Load Posted Opportunities
        async function loadOpportunities() {
            const listContainer = document.getElementById('opportunitiesList');
            
            try {
                const q = query(
                    collection(db, 'opportunities'),
                    where('ngoId', '==', currentUser.uid)
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="empty-state">No opportunities posted yet</p>';
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const opp = doc.data();
                    html += `
                        <div class="opportunity-item">
                            <div class="opp-header">
                                <h3>${opp.title}</h3>
                                <div class="badges">
                                    ${opp.urgent ? '<span class="badge urgent">üö® Urgent</span>' : ''}
                                    ${opp.micro ? '<span class="badge micro">‚è± Quick Help</span>' : ''}
                                </div>
                            </div>
                            <p>${opp.description}</p>
                            <p><strong>Skills:</strong> ${opp.skills.join(', ')}</p>
                            <p><strong>Location:</strong> ${opp.location}</p>
                            <button onclick="deleteOpportunity('${doc.id}')" class="btn-delete">Delete</button>
                        </div>
                    `;
                });

                listContainer.innerHTML = html;
            } catch (error) {
                listContainer.innerHTML = `<p class="error-msg">${error.message}</p>`;
            }
        }

        // Delete Opportunity
        window.deleteOpportunity = async (oppId) => {
            if (confirm('Are you sure you want to delete this opportunity?')) {
                try {
                    await deleteDoc(doc(db, 'opportunities', oppId));
                    loadOpportunities();
                } catch (error) {
                    alert('Error deleting opportunity: ' + error.message);
                }
            }
        };
    </script>
</body>
</html>
